"use strict";(self.webpackChunkmillegrilles_maitredescomptes_client=self.webpackChunkmillegrilles_maitredescomptes_client||[]).push([[904],{28904:function(e,r,n){n.r(r),n.d(r,{default:function(){return P}});var t=n(74165),a=n(15861),s=n(29439),i=n(72791),c=n(43360),l=n(89743),o=n(2677),u=n(22020),p=n(1413),f=n(18267),d=n(75630),h=n(98052),g=n(30616),m=n(80184),x=n(19778).Buffer;var v=function(e){var r=e.setCleMillegrille,n=e.erreurCb,t=(0,i.useState)(""),a=(0,s.Z)(t,2),c=a[0],l=a[1],o=(0,i.useState)(""),u=(0,s.Z)(o,2),f=u[0],d=u[1],g=(0,i.useCallback)((function(e){return d(e.currentTarget.value)}),[d]);return(0,i.useEffect)((function(){if(c&&f)try{var e=(0,h.chargerPemClePriveeEd25519)(c,{password:f,pemout:!0});console.debug("Cle privee millegrille extraite %O",e);var t=(0,h.publicKeyFromPrivateKey)(e.privateKeyBytes);r((0,p.Z)((0,p.Z)({},e),{},{publicKey:t}))}catch(a){n(a)}}),[c,f,r,n]),(0,m.jsx)(b,{cleChiffree:c,setCleChiffree:l,motdepasse:f,setMotdepasse:g,erreurCb:n})};function b(e){var r=e.motdepasse,n=e.setMotdepasse,t=e.cleChiffree,a=e.setCleChiffree,s=e.erreurCb,c=(0,i.useCallback)((function(e){(function(e){return Z.apply(this,arguments)})(e).then((function(e){return a(e)})).catch((function(e){return s(e,"Erreur chargement cle")}))}),[a,s]);return(0,m.jsxs)(m.Fragment,{children:[(0,m.jsxs)(d.Z.Group,{controlId:"formMotdepasse",children:[(0,m.jsx)(d.Z.Label,{children:"Mot de passe de la cle de MilleGrille"}),(0,m.jsx)(d.Z.Control,{type:"password",name:"motdepasse",value:r,autoComplete:"false",onChange:n,placeholder:"AAAA-bbbb-1111-2222"})]}),(0,m.jsx)("p",{}),(0,m.jsx)("p",{children:"Cliquer sur le bouton suivant pour telecharger le fichier avec la cle de millegrille"}),(0,m.jsx)(f.ZP,{onDrop:c,children:function(e){var r=e.getRootProps,n=e.getInputProps;return(0,m.jsx)("span",{className:"uploadIcon btn btn-secondary",children:(0,m.jsxs)("span",(0,p.Z)((0,p.Z)({},r()),{},{children:[(0,m.jsx)("input",(0,p.Z)({},n())),(0,m.jsx)("span",{className:"fa fa-upload fa-2x"})]}))})}}),t?(0,m.jsx)("span",{children:"Fichier charge"}):""]})}function Z(){return(Z=(0,a.Z)((0,t.Z)().mark((function e(r){var n,a,s;return(0,t.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,C(r);case 2:if(n=e.sent,console.debug("Resultats upload : %O",n),null,!(n.length>0)){e.next=9;break}return s=n[0],a=s.racine.cleChiffree,e.abrupt("return",a);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function C(e){return j.apply(this,arguments)}function j(){return j=(0,a.Z)((0,t.Z)().mark((function e(r){var n;return(0,t.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(r.map(function(){var e=(0,a.Z)((0,t.Z)().mark((function e(r){var n,a,s;return(0,t.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("application/json"!==r.type){e.next=8;break}return n=new FileReader,e.next=4,new Promise((function(e,t){n.onload=function(){var r=n.result,t=String.fromCharCode.apply(null,new Uint8Array(r));e({contenuFichier:t})},n.onerror=function(e){return t(e)},n.readAsArrayBuffer(r)}));case 4:return a=e.sent,console.debug(a),s=JSON.parse(a.contenuFichier),e.abrupt("return",s);case 8:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}()));case 2:return n=e.sent,e.abrupt("return",n);case 4:case"end":return e.stop()}}),e)}))),j.apply(this,arguments)}function y(e,r,n){return w.apply(this,arguments)}function w(){return w=(0,a.Z)((0,t.Z)().mark((function e(r,n,a){var s,i,c,l,o,u,p,f,d,h,m,v;return(0,t.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=(a=a||{}).challenge,i=a.userId,console.debug("authentiferCleMillegrille : %O",n),c=a.activerDelegation,l={challenge:s,nomUsager:r},i&&(l.userId=i),c&&(l.activerDelegation=!0),console.debug("signerMessage: signature avec cle de millegrille : %O",n),o=x.from(n.publicKey.publicKeyBytes).toString("hex"),u=Math.trunc(new Date/1e3),p=JSON.stringify(l),f=[o,u,0,p],e.next=14,(0,g.hacherMessage)(f);case 14:return d=e.sent,h={id:d,pubkey:o,estampille:u,kind:0,contenu:p},m=new g.SignateurMessageEd25519(n),console.debug("authentiferCleMillegrille Hachage message ",d),e.next=20,m.signer(d);case 20:return v=e.sent,h.sig=v,e.abrupt("return",h);case 23:case"end":return e.stop()}}),e)}))),w.apply(this,arguments)}var k=n(74405),M=n(7087);n(58516);var P=function(e){(0,i.useEffect)((function(){return console.info("SectionActiverDelegation PROPPIES ",e)}),[e]);var r=e.confirmationCb,n=e.erreurCb,t=e.fermer,a=(0,u.$)().t,p=(0,M.ZP)(),f=(0,M.ZY)()[0],d=(0,i.useState)(""),h=(0,s.Z)(d,2),g=h[0],x=h[1],b=(0,i.useState)(""),Z=(0,s.Z)(b,2),C=Z[0],j=Z[1],y=(0,i.useState)(""),w=(0,s.Z)(y,2),k=w[0],P=w[1];return(0,i.useEffect)((function(){g&&k&&!0!==C&&function(e,r,n,t){return S.apply(this,arguments)}(p,f,k,g).then((function(){return j(!0)})).then((function(){r("Delegation completee avec succes. Le certificat de compte proprietaire est maintenant installe."),t()})).catch(n)}),[p,C,f,j,k,g,r,n,t]),(0,i.useEffect)((function(){var e=window.location.hostname;p.connexion.genererChallenge({hostname:e,delegation:!0}).then((function(e){console.debug("Recu challenge de delegation : ",e),P(e.delegation_challenge)})).catch((function(e){n(e,"Erreur reception challenge de delegation du serveur"),t()}))}),[p,f,P,n,t]),(0,m.jsxs)(l.Z,{children:[(0,m.jsx)(o.Z,{xs:0,sm:1,md:2,lg:3}),(0,m.jsxs)(o.Z,{xs:12,sm:10,md:8,lg:6,children:[(0,m.jsxs)(l.Z,{children:[(0,m.jsx)(o.Z,{xs:10,md:11,children:(0,m.jsx)("h2",{children:a("ActiverDelegation.titre")})}),(0,m.jsx)(o.Z,{xs:2,md:1,className:"bouton",children:(0,m.jsx)(c.Z,{onClick:t,variant:"secondary",children:(0,m.jsx)("i",{className:"fa fa-remove"})})})]}),(0,m.jsx)("p",{children:a("ActiverDelegation.description")}),(0,m.jsx)(v,{setCleMillegrille:x,erreurCb:n}),(0,m.jsx)("p",{})]})]})};function S(){return(S=(0,a.Z)((0,t.Z)().mark((function e(r,n,a,s){var i,c,l,o,u,p,f;return(0,t.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r.connexion,c=n.nomUsager,l=n.certificat,o=(0,k.ei)(l.join("")),e.next=5,y(c,s,{challenge:a,userId:o,activerDelegation:!0});case 5:return u=e.sent,console.debug("Preuve signee : %O",u),p={confirmation:u,userId:o,nomUsager:c,hostname:window.location.hostname},console.debug("Commande activer delegation : %O",p),e.next=11,i.activerDelegationParCleMillegrille(p);case 11:if(!(f=e.sent).err){e.next=14;break}throw new Error(f.err);case 14:return e.abrupt("return",f);case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}}]);
//# sourceMappingURL=904.ace19a89.chunk.js.map