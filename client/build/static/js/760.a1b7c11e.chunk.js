"use strict";(self.webpackChunkmillegrilles_maitredescomptes_client=self.webpackChunkmillegrilles_maitredescomptes_client||[]).push([[760],{85760:function(e,n,r){r.r(n),r.d(n,{default:function(){return w}});var t=r(74165),i=r(1413),a=r(15861),o=r(37762),s=r(93433),c=r(29439),l=r(31243),u=r(72791),p=r(89743),f=r(2677),d=r(36957),h=r(30018),g=r(2869),m=r(22020),v=r(58516),b=r(7087),x=r(74405),j=r(80184);function y(e){var n=e.erreurCb,r=(0,b.ZP)(),t=(0,b.wg)(),i=(0,b.ZY)()[0],a=(0,b.Sy)(),o=r.connexion,s=(0,u.useMemo)((function(){return!!i&&"proprietaire"===(i.extensions||{}).delegationGlobale}),[i]),l=(0,u.useState)([]),d=(0,c.Z)(l,2),h=d[0],m=d[1],v=(0,u.useState)(!0),x=(0,c.Z)(v,2),y=x[0],k=x[1];(0,u.useEffect)((function(){t&&a&&o.requeteListeApplications().then((function(e){var n=e.resultats;console.debug("Liste applications : %O",n),m(n)})).catch((function(e){console.error("Erreur chargement liste applications : %O",e)}))}),[t,a,o]);var O=s?"usager-proprietaire":"";return(0,j.jsx)("div",{children:(0,j.jsxs)(p.Z,{children:[(0,j.jsxs)(f.Z,{xs:12,md:6,children:[(0,j.jsxs)("p",{className:"usager "+O,children:[(0,j.jsx)("i",{className:"fa fa-user-circle-o"})," @"+i.nomUsager]}),(0,j.jsx)(P,{webauthnActif:y,setWebauthnActif:k,erreurCb:n}),(0,j.jsx)(U,{disabled:!y,erreurCb:n})]}),(0,j.jsxs)(f.Z,{xs:12,md:6,children:[(0,j.jsx)("h2",{children:(0,j.jsx)(g.c,{children:"Applications.titre"})}),(0,j.jsx)(Z,{applicationsExternes:h,usagerProprietaire:s})]})]})})}function Z(e){var n=e.applicationsExternes,r=e.typeAdresse,t=(0,u.useMemo)((function(){if(!n)return null;var e=(0,s.Z)(n);return e.sort((function(e,n){var r=e.application||"",t=n.application||"";return r===t?0:r.localeCompare(t)})),e}),[n]),i=(0,u.useMemo)((function(){if(!t)return[null,null,null];var e,n=new URL(window.location.href),i=r||n.hostname.endsWith(".onion")?"onion":"url",a={},s=(0,o.Z)(t);try{for(s.s();!(e=s.n()).done;){var c=e.value,l=[];if(c.url&&l.push(c.url),c.onion&&l.push(c.onion),l.length>0){var u,p=(0,o.Z)(l);try{for(p.s();!(u=p.n()).done;){var f=u.value,d=new URL(f).hostname,h=a[d];h||(h=[],a[d]=h),h.push(c)}}catch(g){p.e(g)}finally{p.f()}}}}catch(g){s.e(g)}finally{s.f()}return[n,i,a]}),[t,r]),a=(0,c.Z)(i,3),l=a[0],p=a[1],f=a[2];return n&&0!==n.length?(0,j.jsxs)("div",{children:[(0,j.jsx)(d.Z,{className:"flex-column applications",children:(0,j.jsx)(k,{urlSite:l,typeAdresse:p,apps:f[l.hostname]})}),(0,j.jsx)(O,{urlSite:l,typeAdresse:p,adressesParHostname:f}),(0,j.jsx)(O,{urlSite:l,typeAdresse:p,adressesParHostname:f,onion:!0})]}):(0,j.jsxs)(h.Z,{variant:"dark",children:[(0,j.jsx)(h.Z.Heading,{children:(0,j.jsx)(g.c,{children:"Applications.titre"})}),(0,j.jsx)(g.c,{children:"Applications.nondisponibles"})]})}function k(e){var n=e.typeAdresse,r=e.apps,t=(0,m.$)().t;return r?r.filter((function(e){return void 0===e.supporte_usagers||!1!==e.supporte_usagers})).map((function(e){var r=new URL(e[n]),i="noname";return e.nameprop?i=t(e.name_property):e.application&&(i=e.application.replace("_"," ")),(0,j.jsx)(d.Z.Link,{href:r.href,rel:"noopener noreferrer",children:i},r.href)})):""}function O(e){var n=e.urlSite,r=e.adressesParHostname,t=e.onion||!1,i=(0,u.useMemo)((function(){return r?Object.keys(r).filter((function(e){return e!==n.hostname&&(e.endsWith(".onion")?t:!t)})):[]}),[n,r,t]);if(0===i.length)return"";var a=null;return a=t?(0,j.jsxs)(j.Fragment,{children:[(0,j.jsx)("h4",{children:"Sites Tor"}),(0,j.jsx)("p",{children:"Note : les hyperliens .onion requierent un navigateur qui a acces au reseau Tor (e.g. Brave en mode 'prive tor')."})]}):(0,j.jsx)("h4",{children:"Sites alternatifs"}),(0,j.jsxs)("div",{children:[a,(0,j.jsx)(d.Z,{className:"flex-column applications",children:i.map((function(e){var n="",r=e;return e.endsWith(".onion")&&(n+=" tor-nav",r=r.slice(0,8)+"[...]"+r.slice(48)),(0,j.jsx)(d.Z.Link,{className:n,href:"https://"+e,children:r},e)}))})]})}function P(e){var n=e.webauthnActif,r=e.setWebauthnActif,t=e.erreurCb,i=(0,m.$)().t,a=(0,b.ZP)(),o=(0,b.ZY)()[0],s=(0,b.zy)(),p=(0,c.Z)(s,2),f=p[0],d=p[1],g=(0,u.useCallback)((function(e){r(!0)}),[r]);return(0,u.useEffect)((function(){if(o){console.debug("Applications usagerDb : ",o);var e=o.nomUsager,n=o.fingerprintPk;f||(0,l.Z)({method:"POST",url:"/auth/get_usager",data:{nomUsager:e,hostname:window.location.hostname,fingerprintPkCourant:n}}).then((function(e){var n=JSON.parse(e.data.contenu);console.debug("Applications Chargement get_usager ",n),d(n)})).catch((function(e){return console.error("Erreur chargement usager ",e)}))}}),[a,o,f,d,r]),(0,u.useEffect)((function(){f&&(console.debug("Verifier si activation presente pour usager ",f),((f.infoUsager||{}).methodesDisponibles||f.methodesDisponibles||{}).activation&&(console.info("Auth sans webauthn disponible pour le cert local - INSECURE"),r(!1)))}),[a,f,d,r]),(0,j.jsxs)(h.Z,{show:!n,variant:"warning",children:[(0,j.jsx)("p",{children:i("Applications.compte-debloque-1")}),(0,j.jsx)("p",{children:i("Applications.compte-debloque-2")}),(0,j.jsxs)(v.XH,{workers:a,confirmationCb:g,erreurCb:t,variant:"secondary",children:["+",(0,j.jsx)("i",{className:"fa fa-key"})]})]})}function U(e){var n=e.confirmationCb,r=e.erreurCb,o=e.disabled;console.debug("UpdateCertificat proppies %O",e);var s=(0,b.ZP)(),l=(0,b.ZY)(),p=(0,c.Z)(l,2),f=p[0],d=p[1],g=(0,b.zy)(),m=(0,c.Z)(g,2),y=m[0],Z=m[1],k=(0,u.useMemo)((function(){if(o||!f||!y)return!1;console.debug("UpdateCertificat verifier version obsolete : usagerDb %O, usagerWebAuth %O, usagerSocketIo %O",f,y);var e=f.delegations_version||0,n=!1;if(y&&y.infoUsager&&void 0!==y.infoUsager.delegations_version){var c=y.infoUsager.delegations_version||0;console.debug("UpdateCertificat Version delegations compte : ",c),n=e<c}else if(f){var l=f.nomUsager,u=f.requete||{},p=u.fingerprintPk;console.debug("UpdateCertificat getInfoUsager pour %s",l),s.connexion.getInfoUsager(l,{hostname:window.location.hostname,fingerprintPkNouveau:p}).then(function(){var e=(0,a.Z)((0,t.Z)().mark((function e(n){var r,a,o,c,f,h,g,m,v,b;return(0,t.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.debug("UpdateCertificat Reception infoVersion : ",n),!0!==n.ok){e.next=23;break}if(r=y.infoUsager?(0,i.Z)({},y.infoUsager):{},a=n.compte,!n.__original.attachements||!n.__original.attachements.certificat){e.next=20;break}if(o=n.__original.attachements.certificat,!(c=JSON.parse(o.contenu)).chaine_pem){e.next=20;break}if(console.info("Nouveau certificat recu en attachement"),f=c.chaine_pem,h=c.fingerprint,p!==h){e.next=20;break}return console.debug("Certificat match requete, on conserve"),g=u.clePriveePem,m=u.fingerprintPk,v={clePriveePem:g,fingerprintPk:m,delegations_version:a.delegations_version,delegations_date:a.delegations_date},e.next=16,(0,x.rg)(l,f,v);case 16:return e.next=18,s.usagerDao.getUsager(l);case 18:b=e.sent,d(b);case 20:r.delegations_version=0,Object.assign(r,n.compte),Z((0,i.Z)((0,i.Z)({},y),{},{infoUsager:r}));case 23:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}()).catch(r)}return console.debug("UpdateCertificat obsolete %s : db=%s",n,e),n}),[s,o,f,d,y,Z,r]),O=(0,u.useCallback)((function(e){console.debug("UpdateCertificat Resultat update certificat : %O",e);var i=f.nomUsager,o=f.requete,c=y.infoUsager;if(e.ok){var l={clePriveePem:o.clePriveePem,fingerprintPk:o.fingerprintPk,delegations_version:c.delegations_version,delegations_date:c.delegations_date};(0,x.rg)(i,e.certificat,l).then((0,a.Z)((0,t.Z)().mark((function e(){var r;return(0,t.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n&&n("Certificat mis a jour"),e.next=3,s.usagerDao.getUsager(i);case 3:return r=e.sent,d(r),e.next=7,s.connexion.reconnecter();case 7:return e.next=9,s.connexion.onConnect();case 9:case"end":return e.stop()}}),e)})))).catch(r)}else r("Erreur mise a jour certificat : "+e.err)}),[s,f,d,y,n,r]);return(0,u.useEffect)((function(){if(k&&(console.debug("UpdateCertificat (usager: %O)",f),!(f.requete||{}).fingerprintPk)){console.debug("UpdateCertificat Generer nouveau certificat pour ",f);var e=f.nomUsager;(0,v.xt)(s,e).then(function(){var n=(0,a.Z)((0,t.Z)().mark((function n(r){var a,o,c,l,u;return(0,t.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(console.debug("UpdateCertificat Cle challenge/csr : %O",r),!r){n.next=7;break}return a=r.cleCsr,o=a.csr,c=a.clePriveePem,l=a.fingerprint_pk,u={csr:o,clePriveePem:c,fingerprintPk:l},n.next=6,s.usagerDao.updateUsager(e,{nomUsager:e,requete:u});case 6:d((0,i.Z)((0,i.Z)({},f),{},{requete:u}));case 7:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}()).catch(r)}}),[s,k,f,d,r,o]),f&&f.nomUsager?(0,j.jsxs)(h.Z,{variant:"info",show:k&&!o,children:[(0,j.jsx)(h.Z.Heading,{children:"Nouveau certificat disponible"}),(0,j.jsxs)("p",{children:["De nouvelles informations ou droits d'acces sont disponibles pour votre compte. Cliquez sur le bouton ",(0,j.jsx)("i",{children:"Mettre a jour"})," et suivez les instructions pour mettre a jour le certificat de securite sur ce navigateur."]}),(0,j.jsx)(v.tK,{usager:f,onSuccess:O,onError:r,variant:"secondary",children:"Mettre a jour"})]}):""}var w=function(e){var n=e.setSectionAfficher,r=e.compteUsagerServeur,t=e.erreurCb;return(0,b.wg)()?(0,j.jsx)(y,{setSectionAfficher:n,compteUsagerServeur:r,erreurCb:t}):"Accueil - Chargement en cours"}},2869:function(e,n,r){r.d(n,{c:function(){return x}});var t=r(45987),i=r(71002),a=r(4942),o=r(72791),s=r(85326),c=r(38589),l=r(81426),u=["format"],p=["children","count","parent","i18nKey","context","tOptions","values","defaults","components","ns","i18n","t","shouldUnescape"];function f(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function d(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?f(Object(r),!0).forEach((function(n){(0,a.Z)(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):f(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function h(e,n){if(!e)return!1;var r=e.props?e.props.children:e.children;return n?r.length>0:!!r}function g(e){return e?e.props?e.props.children:e.children:[]}function m(e){return Array.isArray(e)?e:[e]}function v(e,n){if(!e)return"";var r="",a=m(e),s=n.transSupportBasicHtmlNodes&&n.transKeepBasicHtmlNodesFor?n.transKeepBasicHtmlNodesFor:[];return a.forEach((function(e,a){if("string"===typeof e)r+="".concat(e);else if((0,o.isValidElement)(e)){var c=Object.keys(e.props).length,p=s.indexOf(e.type)>-1,f=e.props.children;if(!f&&p&&0===c)r+="<".concat(e.type,"/>");else if(f||p&&0===c)if(e.props.i18nIsDynamicList)r+="<".concat(a,"></").concat(a,">");else if(p&&1===c&&"string"===typeof f)r+="<".concat(e.type,">").concat(f,"</").concat(e.type,">");else{var d=v(f,n);r+="<".concat(a,">").concat(d,"</").concat(a,">")}else r+="<".concat(a,"></").concat(a,">")}else if(null===e)(0,l.ZK)("Trans: the passed in value is invalid - seems you passed in a null child.");else if("object"===(0,i.Z)(e)){var h=e.format,g=(0,t.Z)(e,u),m=Object.keys(g);if(1===m.length){var b=h?"".concat(m[0],", ").concat(h):m[0];r+="{{".concat(b,"}}")}else(0,l.ZK)("react-i18next: the passed in object contained more than one variable - the object should look like {{ value, format }} where format is optional.",e)}else(0,l.ZK)("Trans: the passed in value is invalid - seems you passed in a variable like {number} - please pass in variables for interpolation as full objects like {{number}}.",e)})),r}function b(e,n,r,t,a,c){if(""===n)return[];var l=t.transKeepBasicHtmlNodesFor||[],u=n&&new RegExp(l.join("|")).test(n);if(!e&&!u)return[n];var p={};!function e(n){m(n).forEach((function(n){"string"!==typeof n&&(h(n)?e(g(n)):"object"!==(0,i.Z)(n)||(0,o.isValidElement)(n)||Object.assign(p,n))}))}(e);var f=s.Z.parse("<0>".concat(n,"</0>")),v=d(d({},p),a);function b(e,n,r){var t=g(e),i=j(t,n.children,r);return function(e){return"[object Array]"===Object.prototype.toString.call(e)&&e.every((function(e){return(0,o.isValidElement)(e)}))}(t)&&0===i.length?t:i}function x(e,n,r,t,i){e.dummy&&(e.children=n),r.push((0,o.cloneElement)(e,d(d({},e.props),{},{key:t}),i?void 0:n))}function j(n,a,s){var p=m(n);return m(a).reduce((function(n,a,f){var g=a.children&&a.children[0]&&a.children[0].content&&r.services.interpolator.interpolate(a.children[0].content,v,r.language);if("tag"===a.type){var m=p[parseInt(a.name,10)];!m&&1===s.length&&s[0][a.name]&&(m=s[0][a.name]),m||(m={});var y=0!==Object.keys(a.attrs).length?function(e,n){var r=d({},n);return r.props=Object.assign(e.props,n.props),r}({props:a.attrs},m):m,Z=(0,o.isValidElement)(y),k=Z&&h(a,!0)&&!a.voidElement,O=u&&"object"===(0,i.Z)(y)&&y.dummy&&!Z,P="object"===(0,i.Z)(e)&&null!==e&&Object.hasOwnProperty.call(e,a.name);if("string"===typeof y){var U=r.services.interpolator.interpolate(y,v,r.language);n.push(U)}else if(h(y)||k){x(y,b(y,a,s),n,f)}else if(O){var w=j(p,a.children,s);n.push((0,o.cloneElement)(y,d(d({},y.props),{},{key:f}),w))}else if(Number.isNaN(parseFloat(a.name))){if(P)x(y,b(y,a,s),n,f,a.voidElement);else if(t.transSupportBasicHtmlNodes&&l.indexOf(a.name)>-1)if(a.voidElement)n.push((0,o.createElement)(a.name,{key:"".concat(a.name,"-").concat(f)}));else{var C=j(p,a.children,s);n.push((0,o.createElement)(a.name,{key:"".concat(a.name,"-").concat(f)},C))}else if(a.voidElement)n.push("<".concat(a.name," />"));else{var E=j(p,a.children,s);n.push("<".concat(a.name,">").concat(E,"</").concat(a.name,">"))}}else if("object"!==(0,i.Z)(y)||Z)1===a.children.length&&g?n.push((0,o.cloneElement)(y,d(d({},y.props),{},{key:f}),g)):n.push((0,o.cloneElement)(y,d(d({},y.props),{},{key:f})));else{var _=a.children[0]?g:null;_&&n.push(_)}}else if("text"===a.type){var S=t.transWrapTextNodes,A=c?t.unescape(r.services.interpolator.interpolate(a.content,v,r.language)):r.services.interpolator.interpolate(a.content,v,r.language);S?n.push((0,o.createElement)(S,{key:"".concat(a.name,"-").concat(f)},A)):n.push(A)}return n}),[])}return g(j([{dummy:!0,children:e||[]}],f,m(e||[]))[0])}function x(e){var n=e.children,r=e.count,i=e.parent,a=e.i18nKey,s=e.context,u=e.tOptions,f=void 0===u?{}:u,h=e.values,g=e.defaults,m=e.components,x=e.ns,j=e.i18n,y=e.t,Z=e.shouldUnescape,k=(0,t.Z)(e,p),O=(0,o.useContext)(c.OO)||{},P=O.i18n,U=O.defaultNS,w=j||P||(0,c.nI)();if(!w)return(0,l.O4)("You will need to pass in an i18next instance by using i18nextReactModule"),n;var C=y||w.t.bind(w)||function(e){return e};s&&(f.context=s);var E=d(d({},(0,c.JP)()),w.options&&w.options.react),_=x||C.ns||U||w.options&&w.options.defaultNS;_="string"===typeof _?[_]:_||["translation"];var S=g||v(n,E)||E.transEmptyNodeValue||a,A=E.hashTransKey,N=a||(A?A(S):S),D=h?f.interpolation:{interpolation:d(d({},f.interpolation),{},{prefix:"#$?",suffix:"?$#"})},q=d(d(d(d({},f),{},{count:r},h),D),{},{defaultValue:S,ns:_}),H=b(m||n,N?C(N,q):S,w,E,q,Z),K=void 0!==i?i:E.defaultTransParent;return K?(0,o.createElement)(K,k,H):H}}}]);
//# sourceMappingURL=760.a1b7c11e.chunk.js.map