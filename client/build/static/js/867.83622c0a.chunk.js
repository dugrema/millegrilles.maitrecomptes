(self.webpackChunkmillegrilles_maitredescomptes_client=self.webpackChunkmillegrilles_maitredescomptes_client||[]).push([[867],{92820:function(e,n,r){"use strict";r.r(n),r.d(n,{default:function(){return E}});var t=r(29439),o=r(72791),i=r(22020),s=r(30018),c=r(47022),a=r(21105),u=r(53229),l=r(94774),f=r(38589),d=r(72426),h=r.n(d);a.ZP.use(u.Z).use(l.Z).use(f.Db).init({fallbackLng:"fr",backend:{loadPath:"/millegrilles/locales/{{lng}}/{{ns}}.json"},interpolation:{escapeValue:!1,format:function(e,n,r){return e instanceof Date?h()(e).locale(r).format(n):isNaN(e)||isNaN(n)?e:Number(e).toFixed(n)}}});var x=a.ZP,m=r(20829),g=r(7087),p=r(80184);(0,m.initI18n)(x);var v=(0,o.lazy)((function(){return Promise.all([r.e(243),r.e(585)]).then(r.bind(r,50585))})),k=(0,o.lazy)((function(){return Promise.all([r.e(243),r.e(414),r.e(406),r.e(666),r.e(89),r.e(386)]).then(r.bind(r,16386))})),b=(0,o.lazy)((function(){return Promise.all([r.e(243),r.e(414),r.e(406),r.e(89),r.e(760)]).then(r.bind(r,85760))})),j=(0,o.lazy)((function(){return Promise.all([r.e(243),r.e(414),r.e(406),r.e(267),r.e(89),r.e(904)]).then(r.bind(r,28904))})),w=(0,o.lazy)((function(){return Promise.all([r.e(243),r.e(414),r.e(406),r.e(89),r.e(187)]).then(r.bind(r,61187))})),C=(0,o.lazy)((function(){return Promise.all([r.e(243),r.e(414),r.e(406),r.e(89),r.e(263)]).then(r.bind(r,23263))}));var E=function(){var e=(0,o.useState)(!1),n=(0,t.Z)(e,2),r=n[0],i=n[1];return(0,o.useEffect)((function(){document.getElementById("splash_init3").className=""}),[]),(0,p.jsx)(g.jw,{setErr:i,attente:(0,p.jsx)(Z,{err:r}),children:(0,p.jsx)(m.ErrorBoundary,{errorCb:i,children:(0,p.jsx)(o.Suspense,{fallback:(0,p.jsx)(y,{}),children:(0,p.jsx)(S,{})})})})};function S(e){var n=(0,i.$)(),r=n.t,a=n.i18n,u=(0,o.useState)(""),l=(0,t.Z)(u,2),f=l[0],d=l[1],h=(0,o.useState)(!1),x=(0,t.Z)(h,2),g=x[0],k=x[1],b=(0,o.useState)(""),j=(0,t.Z)(b,2),w=j[0],C=j[1],E=(0,o.useCallback)((function(e){console.debug("Confirmation : ",e),C(e)}),[C]),S=(0,o.useState)(""),Z=(0,t.Z)(S,2),P=Z[0],W=Z[1],O=(0,o.useCallback)((function(e,n){console.error("Erreur ",e),W({err:e,message:n})}),[W]);(0,o.useEffect)((function(){if(console.debug("Section afficher : %O",f),f){var e=document.getElementById("splash"),n=document.getElementById("root");e.className="splash hide",n.className="root"}}),[f]);var I=(0,p.jsx)(v,{i18n:a,setSectionAfficher:d});return(0,p.jsx)(o.Suspense,{fallback:(0,p.jsx)(y,{}),children:(0,p.jsxs)(m.LayoutMillegrilles,{menu:I,children:[(0,p.jsxs)(s.Z,{variant:"success",show:!!w,onClose:function(){return C("")},dismissible:!0,children:[(0,p.jsx)(s.Z.Heading,{showButton:!0,children:"Confirmation"}),(0,p.jsx)("p",{children:w})]}),(0,p.jsx)(c.Z,{className:"contenu",children:(0,p.jsx)(A,{confirmationCb:E,erreurCb:O,sectionAfficher:f,setSectionAfficher:d})}),(0,p.jsx)(m.ModalAttente,{show:g,setAttente:k}),(0,p.jsx)(m.ModalErreur,{show:!!P,err:P.err,message:P.message,titre:r("Erreur.titre"),fermer:function(){return W("")}})]})})}function Z(e){var n=e.err;return(0,p.jsxs)("div",{children:[(0,p.jsx)("div",{className:"navinit",children:(0,p.jsx)("nav",{children:(0,p.jsx)("span",{children:"MilleGrilles"})})}),(0,p.jsx)("p",{className:"titleinit",children:"Preparation de la MilleGrille"}),(0,p.jsx)("p",{children:"Veuillez patienter durant le chargement de la page."}),(0,p.jsxs)("ol",{children:[(0,p.jsx)("li",{children:"Initialisation"}),(0,p.jsx)("li",{children:"Chargement des composants dynamiques"}),(0,p.jsx)("li",{children:"Connexion a la page"})]}),(0,p.jsx)(P,{err:n})]})}function y(e){var n=(0,g.Sy)();return(0,p.jsxs)("div",{children:[(0,p.jsx)("div",{className:"navinit",children:(0,p.jsx)("nav",{children:(0,p.jsx)("span",{children:"MilleGrilles"})})}),(0,p.jsx)("p",{className:"titleinit",children:"Preparation de la MilleGrille"}),(0,p.jsx)("p",{children:"Veuillez patienter durant le chargement de la page."}),(0,p.jsxs)("ol",{children:[(0,p.jsx)("li",{children:"Initialisation"}),(0,p.jsx)("li",{children:"Chargement des composants dynamiques"}),(0,p.jsx)("li",{children:"Connexion a la page"}),n?(0,p.jsx)("li",{children:"Connecte"}):""]})]})}function P(e){var n=e.err;return(0,p.jsxs)(s.Z,{variant:"warning",show:!!n,children:[(0,p.jsx)(s.Z.Heading,{children:"Erreur de connexion"}),(0,p.jsx)("p",{children:"La connexion au serveur a echoue. L'erreur est temporaire, veuillez ressayer plus tard."}),(0,p.jsx)("h4",{children:"Detail"}),n.message?(0,p.jsx)("p",{children:n.message}):"",(0,p.jsx)("pre",{children:""+n.err})]})}function A(e){var n=e.sectionAfficher,r=e.setSectionAfficher,i=e.confirmationCb,s=e.erreurCb,c=(0,g.ZP)(),a=(0,g.wg)(),u=(0,g.Jd)()[0],l=(0,g.ZY)(),f=(0,t.Z)(l,2),d=f[0],h=f[1],x=(0,g.cd)()[0],m=(0,o.useCallback)((function(){return r("")}),[r]);(0,o.useEffect)((function(){null===u||n||r(!0)}),[u,n]),(0,o.useEffect)((function(){if(!0===u&&!d&&x){console.debug("Usager socket io %O",x);var e=x.nomUsager;c.usagerDao.getUsager(e).then((function(e){console.debug("Usager DB charge : %O",e),h(e)})).catch((function(n){return console.error("Contenu usagerDao.getUsager Erreur chargement %s : %O",e,n)}))}}),[c,u,d,h,x]);var v=(0,o.useMemo)((function(){if(a)switch(n){case"SectionActiverDelegation":return j;case"SectionActiverCompte":return w;case"SectionAjouterMethode":return C;default:return r("Accueil"),b}return!1===u?k:y}),[n,u,a]);return(0,p.jsx)(v,{fermer:m,confirmationCb:i,erreurCb:s})}},7087:function(e,n,r){"use strict";r.d(n,{jw:function(){return C},ZP:function(){return m},Sy:function(){return k},wg:function(){return j},Jd:function(){return w},jB:function(){return b},ZY:function(){return p},cd:function(){return v},zy:function(){return g}});var t=r(74165),o=r(15861),i=r(1413),s=r(29439),c=r(72791),a=r(61555),u=r(20829);function l(){var e,n={connexion:(e=new Worker(new URL(r.p+r.u(297),r.b),{type:void 0}),{proxy:(0,a.Ud)(e),worker:e})},t=Object.keys(n).reduce((function(e,r){return e[r]=n[r].proxy,e}),{});t.usagerDao=u.usagerDao,console.info("WIRE WORKERS start");var o=function(e){return f.apply(this,arguments)}(t);return console.info("WIRE WORKERS OK"),{workerInstances:n,workers:t,ready:o}}function f(){return(f=(0,o.Z)((0,t.Z)().mark((function e(n){var o,i,s,c,a,u,l,f;return(0,t.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=n.connexion,(i=new URL(window.location)).pathname="/fiche.json",e.next=5,Promise.all([r.e(243),r.e(477)]).then(r.bind(r,7477));case 5:return s=e.sent,c=s.default,e.next=9,c.get(i.href);case 9:if(a=e.sent,e.prev=10,u=a.data||{},l=JSON.parse(u.contenu),console.debug("wireWorkers avec fiche ",l),!(f=l.ca)){e.next=19;break}return console.debug("initialiserCertificateStore (connexion, chiffrage)"),e.next=19,o.initialiserCertificateStore(f,{isPEM:!0,DEBUG:!1});case 19:e.next=25;break;case 21:throw e.prev=21,e.t0=e.catch(10),console.error("wireWorkers Erreur chargement fiche ",e.t0),e.t0;case 25:case"end":return e.stop()}}),e,null,[[10,21]])})))).apply(this,arguments)}var d=r(83653),h=r(80184),x=(0,c.createContext)();var m=function(){return(0,c.useContext)(x).workers};function g(){var e=(0,c.useContext)(x);return[e.usagerWebAuth,e.setUsagerWebAuth]}function p(){var e=(0,c.useContext)(x);return[e.usagerDb,e.setUsagerDb]}function v(){var e=(0,c.useContext)(x);return[e.usagerSocketIo,e.setUsagerSocketIo]}function k(){return(0,c.useContext)(x).etatConnexion}function b(){return(0,c.useContext)(x).formatteurPret}function j(){return(0,c.useContext)(x).etatPret}function w(){var e=(0,c.useContext)(x);return[e.etatSessionActive,e.setEtatSessionActive]}function C(e){var n=e.setErr,r=(0,c.useState)(""),t=(0,s.Z)(r,2),o=t[0],f=t[1],m=(0,c.useState)(!1),g=(0,s.Z)(m,2),p=g[0],v=g[1],k=(0,c.useState)(""),b=(0,s.Z)(k,2),j=b[0],w=b[1],C=(0,c.useState)(""),S=(0,s.Z)(C,2),Z=S[0],y=S[1],P=(0,c.useState)(null),A=(0,s.Z)(P,2),W=A[0],O=A[1],I=(0,c.useState)(""),D=(0,s.Z)(I,2),M=D[0],U=D[1],N=(0,c.useState)(""),z=(0,s.Z)(N,2),B=z[0],R=z[1],G=(0,c.useState)(""),L=(0,s.Z)(G,2),_=L[0],J=L[1];(0,c.useEffect)((function(){console.info("Worker Context Setup workers"),f(l())}),[l]);var K=(0,c.useCallback)((function(e){console.debug("setUsagerSocketIoCb ",e),J(e),e&&e.auth&&O(!0)}),[J]),V=(0,c.useCallback)((function(e){if(e.certificat)try{var n=d.pki.certificateFromPem(e.certificat[0]),r=u.forgecommon.extraireExtensionsMillegrille(n);e=(0,i.Z)((0,i.Z)({},e),{},{extensions:r,userId:r.userId})}catch(t){console.warn("Erreur extraction extensions millegrilles du certificat : %O",t)}R(e)}),[R]),Y=(0,c.useMemo)((function(){var e=!!B&&!!W;return console.debug("WorkerProvider.etatAuthentifie = %s (etatSessionActive: %s,usagerDb: %O)",e,W,B),e}),[B,W]),q=(0,c.useMemo)((function(){var e=Z&&Y;return console.debug("WorkerProvider.etatPret = %s (formatteurPret: %s, etatAuthentifie: %s)",e,Z,Y),e}),[Z,Y]),F=(0,c.useMemo)((function(){if(p)return{usagerWebAuth:M,setUsagerWebAuth:U,usagerDb:B,setUsagerDb:V,usagerSocketIo:_,setUsagerSocketIo:J,etatSessionActive:W,setEtatSessionActive:O,workers:o.workers,etatConnexion:j,formatteurPret:Z,etatAuthentifie:Y,etatPret:q}}),[o,p,M,U,B,V,_,J,W,O,j,Z,Y,q]);return(0,c.useEffect)((function(){if(o){console.info("Initialiser web workers (ready : %O, workers : %O)",o.ready,o);var e=u.usagerDao.init();return Promise.all([e,o.ready]).then((function(){console.info("Workers prets"),v(!0)})).catch((function(e){if(console.error("WorkerProvider Erreur initialisation usagers IDB / workers ",e),"AxiosError"===e.name){var r=e.response||{};console.debug("Erreur axios : ",r),n({ok:!1,err:e,message:"Erreur durant le chargement d'information de la MilleGrille (fiche.json : ".concat(r.status,")")})}else n({ok:!1,err:e})})),function(){var e;console.info("Cleanup web workers"),e=o.workerInstances,console.info("Cleanup workers"),Object.values(e).forEach((function(n){try{var r=n.worker,t=n.proxy;try{var o=t.disconnectCleanup().then((function(){console.debug("CleanupWorkers disconnect cleanup result : %O",o)})).catch((function(e){return console.warn("Disconnect cleanup error : %O",e)}))}catch(i){console.warning("cleanupWorkers Erreur ",i)}t[a.Yy](),r.terminate()}catch(i){console.warn("Errreur fermeture worker : %O\n(Workers: %O)",i,e)}}))}}}),[o,v,n]),(0,c.useEffect)((function(){o&&p&&(o.workers.connexion?function(e,n,r,t){return E.apply(this,arguments)}(o.workers,K,w,y).then((function(e){!1===e.ok?(console.error("WorkerContext Erreur de connexion [1] : %O",e),J(""),O(!1)):(console.info("WorkerContext Info connexion : %O",e),J(e),O(e.auth))})).catch((function(e){console.debug("WorkerContext Erreur de connexion [2] : %O",e),J("")})):(console.error("WorkerContext Pas de worker de connexion"),J("")))}),[o,p,J,w,y,O]),(0,c.useEffect)((function(){Y&&o.workers.connexion.getCertificatsMaitredescles().catch((function(e){return console.error("Erreur preload certificat maitre des cles : %O",e)}))}),[o,Y]),p?(0,h.jsx)(x.Provider,{value:F,children:e.children}):(0,h.jsx)(x.Provider,{value:F,children:e.attente})}function E(){return(E=(0,o.Z)((0,t.Z)().mark((function e(n,o,i,s){var c,a;return(0,t.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.e(682).then(r.bind(r,67682));case 2:return c=e.sent,a=c.connecter,e.abrupt("return",a(n,o,i,s));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},66558:function(){},39627:function(){},80950:function(){},46601:function(){},89214:function(){},8623:function(){},7748:function(){},85568:function(){},75992:function(){},78110:function(){},56619:function(){},77108:function(){},52361:function(){},94616:function(){},69862:function(){},40964:function(){},55024:function(){}}]);
//# sourceMappingURL=867.83622c0a.chunk.js.map