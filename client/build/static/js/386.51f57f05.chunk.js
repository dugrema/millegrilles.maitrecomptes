"use strict";(self.webpackChunkmillegrilles_maitredescomptes_client=self.webpackChunkmillegrilles_maitredescomptes_client||[]).push([[386],{16386:function(e,n,t){t.r(n),t.d(n,{default:function(){return N}});var r=t(74165),s=t(1413),c=t(15861),i=t(29439),a=t(31243),o=t(72791),u=t(61555),l=t(89743),h=t(2677),f=t(43360),d=t(75630),x=t(30018),g=t(74711),m=t(22020),p=t(2869),v=t(26718),b=t(20829),j=t(7087),Z=t(58516),C=t(22057),A=t(80184),k=t(19778).Buffer;function U(e){var n=e.value,t=e.size||300,r=e.className||"qr-code-background",s=(0,o.useState)(""),c=(0,i.Z)(s,2),a=c[0],u=c[1];return(0,o.useEffect)((function(e){if(n){var t=function(e){var n=/\n?-{5}[A-Z ]+-{5}\n?/g,t=e.replaceAll(n,""),r=new Uint8Array(k.from(t,"base64")),s=String.fromCharCode.apply(null,r);return s}(n);u(t)}}),[n]),a?(0,A.jsx)(C.ZP,{className:r,value:a,size:t}):(0,A.jsx)("p",{children:"Chargement en cours"})}var S=t(74405);var N=function(e){var n=e.erreurCb;return(0,A.jsxs)(l.Z,{children:[(0,A.jsx)(h.Z,{xs:0,sm:1,md:2,lg:3}),(0,A.jsxs)(h.Z,{xs:12,sm:10,md:8,lg:6,children:[(0,A.jsx)("p",{}),(0,A.jsx)(y,{erreurCb:n})]})]})};function y(e){var n=e.erreurCb,t=(0,j.ZP)(),a=(0,j.ZY)(),u=(0,i.Z)(a,2),l=u[0],h=u[1],f=(0,j.zy)(),d=(0,i.Z)(f,2),x=d[0],g=d[1],m=(0,o.useState)(window.localStorage.getItem("usager")||""),p=(0,i.Z)(m,2),v=p[0],b=p[1],Z=(0,o.useState)(window.localStorage.getItem("dureeSession")||"86400"),C=(0,i.Z)(Z,2),k=C[0],U=C[1],N=(0,o.useState)(!1),y=(0,i.Z)(N,2),D=y[0],I=y[1],_=(0,o.useState)(!1),O=(0,i.Z)(_,2),F=O[0],L=O[1],q=(0,o.useState)(!1),T=(0,i.Z)(q,2),z=T[0],G=T[1],B=(0,o.useState)(!1),Y=(0,i.Z)(B,2),$=Y[0],H=Y[1],J=(0,o.useCallback)((function(){v&&(h(""),b(""),L(!0),H(!1),b(v))}),[v,b,L,H,h]);return(0,o.useEffect)((function(){v&&(g(""),l&&l.nomUsager===v||(0,S.Ry)(v).then(function(){var e=(0,c.Z)((0,r.Z)().mark((function e(n){var c,i,a,o,u,l;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(h(n),console.debug("SectionAuthentification usagerLocal : %O",n),c=n.requete||{},i=c.fingerprintPk,a=n.fingerprintPk,!n.certificat||!n.clePriveePem){e.next=8;break}return e.next=6,M(t,n);case 6:e.next=10;break;case 8:return e.next=10,M(t,{});case 10:return e.next=12,(0,S.Gd)(v,i,a,{genererChallenge:!0});case 12:if(o=e.sent,console.debug("SectionAuthentification Charge compte usager : %O",o),!(n.requete&&o.infoUsager&&o.infoUsager.certificat)){e.next=22;break}return console.info("Nouveau certificat recu : %O",o.infoUsager),u=(0,s.Z)((0,s.Z)({},o.infoUsager),{},{nomUsager:v}),e.next=19,W(t,u);case 19:return l=e.sent,e.next=22,M(t,l);case 22:g(o);case 23:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}()).catch(n))}),[t,v,l,h,g,n]),$?(0,A.jsx)(w,{setAuthentifier:L,setCompteRecovery:H,reloadCompteUsager:J,erreurCb:n}):F&&x?(console.debug("Authentifier avec : %O",x),x.infoUsager?(0,A.jsx)(E,{nouvelUsager:D,setAttente:G,nomUsager:v,dureeSession:k,setAuthentifier:L,setCompteRecovery:H,erreurCb:n}):(0,A.jsx)(P,{setAuthentifier:L,nomUsager:v,erreurCb:n})):(0,A.jsx)(R,{nomUsager:v,setNomUsager:b,nouvelUsager:D,setNouvelUsager:I,attente:z,setAttente:G,setAuthentifier:L,setCompteRecovery:H,dureeSession:k,setDureeSession:U,erreurCb:n})}function w(e){var n=e.setAuthentifier,t=e.setCompteRecovery,r=e.reloadCompteUsager,s=e.erreurCb,c=(0,m.$)().t,a=(0,j.ZP)(),d=(0,j.ZY)(),v=(0,i.Z)(d,2),b=v[0],Z=v[1],C=b.requete||{},k=b.nomUsager,N=C.csr,y=C.fingerprintPk;console.debug("CompteRecovery usagerDb ",b);var w=(0,o.useRef)(),P=(0,o.useRef)(),E=(0,o.useState)(""),R=(0,i.Z)(E,2),D=R[0],I=R[1],_=(0,o.useState)(!1),F=(0,i.Z)(_,2),L=F[0],W=F[1],q=(0,o.useState)(!1),M=(0,i.Z)(q,2),T=M[0],z=M[1],G=(0,o.useCallback)((function(e){console.debug("activationFingerprintCb Event : ",e),r()}),[r,a]),B=(0,o.useMemo)((function(){return(0,u.sj)(G)}),[G]);(0,o.useEffect)((function(){if(L){var e=setTimeout((function(){return W(!1)}),5e3);return function(){return clearTimeout(e)}}}),[L,W]),(0,o.useEffect)((function(){if(T){var e=setTimeout((function(){return z(!1)}),5e3);return function(){return clearTimeout(e)}}}),[T,z]);(0,o.useCallback)((function(e,n){e&&![0,11,20].includes(e.code)?s(e,n):s("Erreur authentification annulee ou mauvaise cle")}),[s]);var Y=(0,o.useCallback)((function(){n(!1),t(!1)}),[n,t]),$=(0,o.useCallback)((function(){navigator.clipboard.writeText(D).then((function(){W(!0)})).catch(s)}),[D,W,s]),H=(0,o.useCallback)((function(){navigator.clipboard.writeText(N).then((function(){z(!0)})).catch(s)}),[N,z]);return(0,o.useEffect)((function(){var e=b.requete;k&&(e?O(a,b).catch((function(e){return s(e)})):(console.debug("Generer nouveau CSR"),(0,S.Ry)(k,{regenerer:!0}).then((function(e){return Z(e),O(a,e)})).catch((function(e){return s(e)}))))}),[a,k,b,Z,s]),(0,o.useEffect)((function(){if(y){var e=y.slice(y.length-8);return e=[(e=e.toLowerCase()).slice(0,4),e.slice(4,8)].join("-"),I(e),console.debug("Enregistrer listener pour fingperintPk %s",y),a.connexion.enregistrerCallbackEvenementsActivationFingerprint(y,B),function(){console.debug("Retirer listener pour fingperintPk %s",y),a.connexion.retirerCallbackEvenementsActivationFingerprint(y,B)}}I("")}),[a,B,y,I]),(0,A.jsxs)(A.Fragment,{children:[(0,A.jsxs)(l.Z,{children:[(0,A.jsx)(h.Z,{xs:10,md:11,children:(0,A.jsx)("h2",{children:c("Authentification.echec-titre")})}),(0,A.jsx)(h.Z,{xs:2,md:1,className:"bouton",children:(0,A.jsx)(f.Z,{onClick:Y,variant:"secondary",children:(0,A.jsx)("i",{className:"fa fa-remove"})})})]}),(0,A.jsx)("p",{children:c("Authentification.echec-description")}),(0,A.jsxs)(l.Z,{children:[(0,A.jsxs)(h.Z,{xs:12,md:6,children:[(0,A.jsx)("h4",{children:c("Authentification.echec-activation-titre")}),(0,A.jsxs)(l.Z,{children:[(0,A.jsx)(h.Z,{xs:4,children:c("Authentification.echec-activation-champ-code")}),(0,A.jsx)(h.Z,{xs:8,className:"code-activation",children:(0,A.jsx)(f.Z,{variant:"link",ref:w,onClick:$,children:D})})]}),(0,A.jsxs)(l.Z,{children:[(0,A.jsx)(h.Z,{xs:4,children:c("Authentification.echec-activation-champ-compte")}),(0,A.jsx)(h.Z,{children:k})]}),(0,A.jsx)("p",{}),(0,A.jsx)("p",{className:"code-instructions",children:c("Authentification.echec-activation-instruction1")})]}),(0,A.jsxs)(h.Z,{xs:12,md:6,children:[(0,A.jsx)("h4",{children:c("Authentification.echec-codeqr-titre")}),(0,A.jsx)(U,{value:N,size:200}),(0,A.jsx)("p",{className:"code-instructions",children:c("Authentification.echec-codeqr-instruction")})]}),(0,A.jsxs)(h.Z,{xs:12,md:6,className:"no-print",children:[(0,A.jsx)("h4",{children:c("Authentification.echec-csr-titre")}),(0,A.jsx)(f.Z,{variant:"secondary",ref:P,onClick:H,children:"Copier"}),(0,A.jsx)("p",{className:"code-instructions",children:c("Authentification.echec-csr-instruction")})]}),(0,A.jsxs)(h.Z,{xs:12,md:6,className:"no-print",children:[(0,A.jsx)("h4",{children:c("Authentification.echec-cle-titre")}),(0,A.jsx)("p",{className:"code-instructions",children:c("Authentification.echec-cle-instruction")})]})]}),(0,A.jsx)("p",{}),(0,A.jsx)(x.Z,{variant:"secondary",children:(0,A.jsx)("div",{children:(0,A.jsx)(p.c,{children:"Authentification.echec-note-securite"})})}),(0,A.jsx)(g.Z,{target:w,show:L,placement:"bottom",children:(0,A.jsxs)("div",{className:"code-activation-overlay",children:["Code copie avec succes ",(0,A.jsx)("i",{className:"fa fa-check"})]})}),(0,A.jsx)(g.Z,{target:P,show:T,placement:"right",children:(0,A.jsxs)("div",{className:"code-activation-overlay",children:["Code copie avec succes ",(0,A.jsx)("i",{className:"fa fa-check"})]})}),(0,A.jsx)("p",{})]})}function P(e){console.debug("!! InscrireUsager %O",e);var n=e.setAuthentifier,t=e.nomUsager,s=e.erreurCb,a=(0,m.$)().t,u=(0,j.ZP)(),d=(0,j.ZY)(),x=(0,i.Z)(d,2),g=(x[0],x[1]),v=(0,o.useState)(""),Z=(0,i.Z)(v,2),C=Z[0],k=Z[1],U=(0,o.useCallback)((function(){k("attente"),function(e,n,t,r){return L.apply(this,arguments)}(u,t,g,s).then((0,c.Z)((0,r.Z)().mark((function e(){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return k("succes"),n(!0),e.next=4,u.connexion.reconnecter();case 4:case"end":return e.stop()}}),e)})))).catch((function(e){k("echec"),s(e)}))}),[u,t,g,k,s]),S=(0,o.useCallback)((function(){return n(!1)}),[n]);return(0,A.jsxs)(A.Fragment,{children:[(0,A.jsx)("h2",{children:(0,A.jsx)(p.c,{children:"Authentification.creer-compte-titre"})}),(0,A.jsxs)("div",{children:[(0,A.jsx)("p",{children:a("Authentification.creer-compte-disponible",{nomUsager:e.nomUsager})}),(0,A.jsx)("p",{children:(0,A.jsx)(p.c,{children:"Authentification.creer-compte-instructions"})}),(0,A.jsxs)(l.Z,{className:"boutons",children:[(0,A.jsx)(h.Z,{className:"bouton-gauche",children:(0,A.jsx)(b.BoutonActif,{etat:C,onClick:U,children:(0,A.jsx)(p.c,{children:"Authentification.bouton-inscrire"})})}),(0,A.jsx)(h.Z,{className:"bouton-droite",children:(0,A.jsx)(f.Z,{variant:"secondary",onClick:S,children:(0,A.jsx)(p.c,{children:"Forms.cancel"})})})]})]})]})}function E(e){var n=e.nouvelUsager,t=e.setAttente,i=e.nomUsager,u=e.dureeSession,d=e.setAuthentifier,g=e.setCompteRecovery,m=e.erreurCb,p=(0,j.ZP)(),b=(0,j.jB)(),C=(0,j.ZY)()[0],k=(0,j.zy)()[0],U=(0,o.useMemo)((function(){if(k&&k.infoUsager){var e=k.infoUsager.authentication_challenge;return console.debug("Authentifier.challengeWebauthn ",e),e}}),[k]),S=(0,o.useCallback)((function(e){console.debug("InputAfficherListeUsagers onSuccessWebAuth ",e);var n=(0,s.Z)((0,s.Z)({},e),{},{nomUsager:i});W(p,n).then((0,c.Z)((0,r.Z)().mark((function n(){return(0,r.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!e.auth){n.next=8;break}return console.info("onSuccessWebAuth Reconnecter pour authentification socket.io"),n.next=4,p.connexion.reconnecter();case 4:return n.next=6,p.connexion.onConnect();case 6:n.next=9;break;case 8:console.error("onSuccessWebAuth Echec Authentification ",e);case 9:case"end":return n.stop()}}),n)})))).catch(m)}),[p,i,d]);(0,o.useEffect)((function(){if(console.debug("Authentifier formatteurPret %s, usagerWebAuth %O",b,k),b&&k&&k.infoUsager){var e=k.infoUsager||{},n=e.methodesDisponibles,t=e.challenge_certificat;if(n.activation&&t){console.debug("Authentification avec signature certificat et challenge ",t);var s={certificate_challenge:t};p.connexion.formatterMessage(s,"auth",{action:"authentifier_usager",kind:v.MESSAGE_KINDS.KIND_COMMANDE}).then(function(){var e=(0,c.Z)((0,r.Z)().mark((function e(n){var t,s;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.Z.post("/auth/authentifier_usager",n);case 2:if(t=e.sent,s=JSON.parse(t.data.contenu),console.debug("Resultat authentification ",t),!s.auth){e.next=13;break}return e.next=8,p.connexion.reconnecter();case 8:return e.next=10,p.connexion.onConnect();case 10:d(!1),e.next=14;break;case 13:m("Erreur authentification : ".concat(s.err));case 14:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}()).catch(m)}}}),[p,b,k,d]);var N=(0,o.useCallback)((function(){return g(!0)}),[g]),y=(0,o.useCallback)((function(){return d(!1)}),[d]),w=(0,A.jsxs)("p",{children:["Ouverture d'une nouvelle session en cours ... ",(0,A.jsx)("i",{className:"fa fa-spinner fa-spin fa-fw"})]});return n&&(w="Cliquez sur Suivant pour vous connecter."),(0,A.jsxs)(A.Fragment,{children:[(0,A.jsxs)(x.Z,{variant:"info",children:[(0,A.jsx)(x.Z.Heading,{children:"Ouverture de session"}),w]}),(0,A.jsx)(l.Z,{children:(0,A.jsxs)(h.Z,{className:"button-list",children:[C&&n?(0,A.jsx)(Z.t4,{nomUsager:i,usagerDb:C,challenge:U,setAttente:t,onSuccess:S,onError:m,dureeSession:u,children:"Suivant"}):"",(0,A.jsx)(f.Z,{variant:"secondary",onClick:N,children:"Utiliser un code"}),(0,A.jsx)(f.Z,{variant:"secondary",onClick:y,children:"Annuler"})]})})]})}function R(e){var n=e.nomUsager,t=e.setNomUsager,r=e.nouvelUsager,s=e.setNouvelUsager,c=e.attente,a=e.setAttente,u=e.setAuthentifier,l=e.setCompteRecovery,h=e.dureeSession,f=e.setDureeSession,x=e.erreurCb,g=(0,o.useState)(""),m=(0,i.Z)(g,2),p=m[0],v=m[1],Z=(0,j.zy)()[0];(0,o.useEffect)((function(){b.usagerDao.getListeUsagers().then((function(e){0===e.length&&s(!0),e.sort(),console.debug("Liste usagers locaux (IDB) ",e),v(e)})).catch((function(e){return x(e)}))}),[v,s,x]);var C=(0,o.useMemo)((function(){return Z&&Z.infoUsager&&(Z.infoUsager.methodesDisponibles||{}).activation||!1}),[Z]);return r?(0,A.jsx)(d.Z.Group,{controlId:"formNomUsager",children:(0,A.jsx)(D,{setNomUsager:t,setNouvelUsager:s,attente:c,setAttente:a,setAuthentifier:u,setCompteRecovery:l,peutActiver:C,dureeSession:h,setDureeSession:f,erreurCb:x})}):(0,A.jsx)(d.Z.Group,{controlId:"formNomUsager",children:(0,A.jsx)(I,{nomUsager:n,setNomUsager:t,setNouvelUsager:s,attente:c,setAttente:a,setAuthentifier:u,listeUsagers:p,setCompteRecovery:l,peutActiver:C,dureeSession:h,setDureeSession:f,erreurCb:x})})}function D(e){var n=e.setNomUsager,t=e.attente,r=e.setAttente,s=e.setNouvelUsager,c=e.setAuthentifier,a=e.erreurCb,u=(0,m.$)().t,x=(0,j.ZP)(),g=(0,o.useState)(""),v=(0,i.Z)(g,2),b=v[0],Z=v[1],C=(0,o.useCallback)((function(e){return Z(e.currentTarget.value)}),[Z]),k=(0,o.useCallback)((function(){return s(!1)}),[s]),U=(0,o.useCallback)((function(){console.debug("BoutonsAuthentifier Suivantcb %s",b),n(b),c(!0)}),[x,b,n,r,c,a]);if(e.show)return"";var S=!b;return(0,A.jsxs)("div",{children:[(0,A.jsxs)(d.Z.Group,{controlId:"formNomUsager",children:[(0,A.jsx)(d.Z.Label,{children:(0,A.jsx)(p.c,{children:"Authentification.nomUsager"})}),(0,A.jsx)(d.Z.Control,{type:"text",placeholder:u("Authentification.saisirNom"),value:b,onChange:C,disabled:t}),(0,A.jsx)(d.Z.Text,{className:"text-muted",children:(0,A.jsx)(p.c,{children:"Authentification.instructions1"})})]}),(0,A.jsxs)(l.Z,{className:"boutons preauth",children:[(0,A.jsx)(h.Z,{xs:12,sm:4,className:"bouton-gauche",children:(0,A.jsx)(f.Z,{variant:"primary",disabled:t||S,onClick:U,children:(0,A.jsx)(p.c,{children:"Forms.next"})})}),(0,A.jsx)(h.Z,{xs:12,sm:4,children:(0,A.jsx)(f.Z,{variant:"secondary",disabled:!0,children:(0,A.jsx)(p.c,{children:"Forms.new"})})}),(0,A.jsx)(h.Z,{xs:12,sm:4,className:"bouton-droite",children:(0,A.jsx)(f.Z,{variant:"secondary",onClick:k,children:(0,A.jsx)(p.c,{children:"Forms.cancel"})})})]})]})}function I(e){var n=e.nomUsager,t=e.setNomUsager,a=e.listeUsagers,u=e.setNouvelUsager,x=e.attente,g=e.setAttente,v=e.setAuthentifier,b=e.setCompteRecovery,Z=e.peutActiver,C=e.dureeSession,k=e.setDureeSession,U=e.erreurCb,S=((0,j.ZY)()[0],(0,j.zy)()[0],(0,j.Jd)()),N=(0,i.Z)(S,2),y=(N[0],N[1]),w=(0,m.$)().t,P=(0,j.ZP)(),E=(0,o.useCallback)((function(){u(!0)}),[t,u]),R=(0,o.useCallback)((function(e){u(!1),t(e.currentTarget.value)}),[t,u]),D=(0,o.useCallback)((function(e){return k(e.currentTarget.value)}),[k]),I=(0,o.useCallback)((function(e){console.debug("InputAfficherListeUsagers onSuccessWebAuth ",e);var t=(0,s.Z)((0,s.Z)({},e),{},{nomUsager:n});W(P,t).then((0,c.Z)((0,r.Z)().mark((function n(){return(0,r.Z)().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!e.auth){n.next=8;break}return console.info("onSuccessWebAuth Reconnecter pour authentification socket.io"),n.next=4,P.connexion.reconnecter();case 4:return n.next=6,P.connexion.onConnect();case 6:n.next=9;break;case 8:console.error("onSuccessWebAuth Echec Authentification ",e);case 9:case"end":return n.stop()}}),n)})))).catch(U)}),[P,n,v,y]),O=(0,o.useCallback)((function(e,n){e&&![0,11,20].includes(e.code)?U(e,n):(b(!0),v(!0))}),[U,b,v]),F=(0,o.useCallback)((function(){console.debug("BoutonsAuthentifier Suivantcb %s",n);try{g(!0),v(!0)}catch(e){U(e)}}),[P,n,g,v,U]);return(0,o.useEffect)((function(){if(a.length>0)if(a.includes(n));else{var e=window.localStorage.getItem("usager");a.includes(e)?t(e):t(a[0])}}),[n,t,a]),a?(0,A.jsxs)("div",{children:[(0,A.jsxs)(d.Z.Group,{controlId:"formNomUsager",children:[(0,A.jsx)(d.Z.Label,{children:(0,A.jsx)(p.c,{children:"Authentification.nomUsager"})}),(0,A.jsx)(d.Z.Select,{type:"text",value:n,placeholder:w("Authentification.saisirNom"),onChange:R,disabled:x,children:e.listeUsagers.map((function(e){return(0,A.jsx)("option",{value:e,children:e},e)}))}),(0,A.jsx)(d.Z.Text,{className:"text-muted",children:(0,A.jsx)(p.c,{children:"Authentification.instructions2"})})]}),(0,A.jsx)("p",{}),(0,A.jsxs)(d.Z.Group,{controlId:"formDureeSession",children:[(0,A.jsx)(d.Z.Label,{children:"Duree de la session"}),(0,A.jsxs)(d.Z.Select,{value:C,onChange:D,disabled:x,children:[(0,A.jsx)("option",{value:"3600",children:"1 heure"}),(0,A.jsx)("option",{value:"86400",children:"1 jour"}),(0,A.jsx)("option",{value:"604800",children:"1 semaine"}),(0,A.jsx)("option",{value:"2678400",children:"1 mois"})]}),(0,A.jsx)(d.Z.Text,{className:"text-muted",children:"Apres cette periode, l'appareil va reverifier votre identite."})]}),(0,A.jsxs)(l.Z,{className:"boutons preauth",children:[(0,A.jsx)(h.Z,{xs:12,sm:4,className:"bouton-gauche",children:(0,A.jsxs)(_,{setAttente:g,onClickWebAuth:I,suivantNoWebauthnHandler:F,erreurAuthCb:O,peutActiver:Z,dureeSession:C,children:[(0,A.jsx)(p.c,{children:"Forms.next"}),Z?[" ",(0,A.jsx)("i",{className:"fa fa-arrow-right"})]:""]})}),(0,A.jsx)(h.Z,{xs:12,sm:4,children:(0,A.jsx)(f.Z,{variant:"secondary",onClick:E,children:(0,A.jsx)(p.c,{children:"Forms.new"})})}),(0,A.jsx)(h.Z,{xs:12,sm:4,className:"bouton-droite",children:(0,A.jsx)(f.Z,{variant:"secondary",disabled:!0,children:(0,A.jsx)(p.c,{children:"Forms.cancel"})})})]})]}):""}function _(e){var n=e.onClickWebAuth,t=e.suivantNoWebauthnHandler,r=e.erreurAuthCb,s=e.peutActiver,c=e.dureeSession,i=(0,j.zy)()[0],a=(0,j.ZY)()[0],u=(0,o.useMemo)((function(){return console.debug("BoutonAuthentifierListe usagerWebAuth : %O",i),!(!i||i.infoUsager)}),[i]),l=(0,o.useMemo)((function(){return i&&i.infoUsager?i.infoUsager.authentication_challenge:""}),[i]);return u||!0===s?(0,A.jsx)(f.Z,{variant:"success",onClick:t,children:e.children}):(0,A.jsx)(Z.t4,{variant:"primary",challenge:l,onSuccess:n,onError:r,usagerDb:a,dureeSession:c,children:e.children})}function O(e,n){return F.apply(this,arguments)}function F(){return(F=(0,c.Z)((0,r.Z)().mark((function e(n,t){var s,c,i,a;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=n.connexion,c=t.nomUsager,i=t.requete,!(c&&i&&i.csr)){e.next=6;break}return a=i.csr,e.next=6,s.ajouterCsrRecovery(c,a);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function L(){return(L=(0,c.Z)((0,r.Z)().mark((function e(n,t,s,c){var i,a,o,u,l,h,f,d,x,g;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,i=n.connexion,e.next=4,(0,S.Ry)(t);case 4:return a=e.sent,o=a.requete||{},u=o.csr,l=o.clePriveePem,h=o.fingerprintPk,console.debug("suivantInscrire Inscrire usager %s avec CSR navigateur\n%O",t,u),e.next=10,i.inscrireUsager(t,u);case 10:if(f=e.sent,console.debug("suivantInscrire Reponse inscription : %O",f),!0===f.ok){e.next=15;break}throw console.warn("Erreur inscription usager : ",f),new Error("Erreur inscription usager : ".concat(f));case 15:if(d=f.certificat){e.next=19;break}return c("Le certificat n'a pas ete recu lors de la confirmation d'inscription.","L'inscription a echouee"),e.abrupt("return");case 19:return x=f.delegations_version||1,f.delegations_version=x,console.debug("suivantInscrire Certificats recus : cert: %O",d),e.next=24,(0,S.rg)(t,d,{clePriveePem:l,fingerprintPk:h,delegations_version:x});case 24:return e.next=26,b.usagerDao.getUsager(t);case 26:return g=e.sent,e.next=29,s(g);case 29:window.localStorage.setItem("usager",t),e.next=36;break;case 32:e.prev=32,e.t0=e.catch(0),console.error("suivantInscrire Erreur inscrire usager : %O",e.t0),c(e.t0,"Erreur inscrire usager");case 36:case"end":return e.stop()}}),e,null,[[0,32]])})))).apply(this,arguments)}function W(e,n){return q.apply(this,arguments)}function q(){return(q=(0,c.Z)((0,r.Z)().mark((function e(n,t){var s,c,i,a,o,u,l,h,f;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.certificat){e.next=4;break}return e.next=3,n.connexion.onConnect();case 3:return e.abrupt("return");case 4:return n.connexion,s=n.usagerDao,c=t.nomUsager,i=t.delegations_date,a=t.delegations_version,o=t.certificat,e.next=8,s.getUsager(c);case 8:if(u=e.sent,console.debug("UsagerDbLocal ",u),console.debug("sauvegarderUsagerMaj Reponse %O, usagerDbLocal %O",t,u),!u.requete){e.next=18;break}return l=u.requete,h=l.clePriveePem,f=l.fingerprintPk,e.next=15,(0,S.rg)(c,o,{clePriveePem:h,fingerprintPk:f,delegations_date:i,delegations_version:a});case 15:return e.next=17,s.getUsager(c);case 17:return e.abrupt("return",e.sent);case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function M(e,n){return T.apply(this,arguments)}function T(){return(T=(0,c.Z)((0,r.Z)().mark((function e(n,t){var s,c,i;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.debug("Preparer formatteur de messages pour usager %O",t),s=n.connexion,c=t.certificat,i=t.clePriveePem,!(s&&c&&i)){e.next=9;break}return e.next=6,s.initialiserFormatteurMessage(c,i);case 6:return e.abrupt("return",!0);case 9:return e.next=11,s.clearFormatteurMessage();case 11:return e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}}]);
//# sourceMappingURL=386.51f57f05.chunk.js.map