!function(){var e={65569:function(e,n,t){"use strict";var r={};t.r(r),t.d(r,{authentifier:function(){return rn},chargerCleMillegrille:function(){return ne},clearCleMillegrille:function(){return re},clearFormatteurMessage:function(){return Ye},connecter:function(){return Se},deconnecter:function(){return Te},emit:function(){return Le},emitBlocking:function(){return ze},estActif:function(){return Me},formatterMessage:function(){return $},genererChallengeWebAuthn:function(){return nn},getCertificatFormatteur:function(){return Ae},getCertificatsMaitredescles:function(){return $e},initialiserCertificateStore:function(){return Ee},initialiserFormatteurMessage:function(){return Ke},isFormatteurReady:function(){return Ve},onConnect:function(){return Oe},reconnecter:function(){return je},setCallbacks:function(){return Ze},signerMessageCleMillegrille:function(){return ee},socketOff:function(){return Fe},socketOn:function(){return Ge},subscribe:function(){return Qe},unsubscribe:function(){return Xe},upgradeProteger:function(){return tn},verifierMessage:function(){return Pe}});var i=t(74165),a=t(1413),c=t(15861),o=t(61555),u=t(26718),s=t(16296),f=t(64777),l=t(9114),p=t(59740),h=t(29781),g=t(81762),d=function(){var e=(0,c.Z)((0,i.Z)().mark((function e(n){var t;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n();case 2:return t=e.sent,e.abrupt("return",{update:function(e){return t.update(e)},finalize:function(){return t.digest("binary")},digest:function(){var e=(0,c.Z)((0,i.Z)().mark((function e(n){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.update(n);case 2:return e.next=4,t.digest("binary");case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}()});case 4:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),m={sha256:function(){return d(g.TX)},"sha2-256":function(){return d(g.TX)},sha512:function(){return d(g.h0)},"sha2-512":function(){return d(g.h0)},blake2s256:function(){return d(g.zc)},"blake2s-256":function(){return d(g.zc)},blake2b512:function(){return d(g.Hp)},"blake2b-512":function(){return d(g.Hp)}};(0,h.setHacheurs)(m);var v=t(93433),y=t(43144),x=t(15671),b=t(60136),k=t(29388),w=t(28664),C=t(94928),Z=t(84797),E=t(89881),_=t.n(E),M=t(86604),S=65536,D=S-17;function A(){return(A=(0,c.Z)((0,i.Z)().mark((function e(n,t){var r,a,c,o,u,s,f,l,p,g;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(r=t=t||{}).key,c=r.nonce,a?"string"===typeof a&&(a=Z.base64.decode(a)):a=(0,M.getRandom)(32),c?"string"===typeof c&&(c=Z.base64.decode(c)):c=(0,M.getRandom)(12),e.next=6,_().ready;case 6:o=_(),e.prev=7,u=o.crypto_aead_chacha20poly1305_ietf_encrypt_detached(n,null,null,c,a),s=u.ciphertext,f=u.mac,e.next=14;break;case 11:throw e.prev=11,e.t0=e.catch(7),new F(""+e.t0);case 14:return e.next=16,(0,h.hacher)(s,t);case 16:return l=e.sent,p=Z.base64.encode(f),g=Z.base64.encode(c),e.abrupt("return",{ciphertext:s,key:a,nonce:g,tag:p,rawTag:f,hachage:l,format:"mgs3"});case 20:case"end":return e.stop()}}),e,null,[[7,11]])})))).apply(this,arguments)}function O(){return(O=(0,c.Z)((0,i.Z)().mark((function e(n,t,r,a){var c;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return"string"===typeof n&&(n=Z.base64.decode(n)),"string"===typeof a&&(a=Z.base64.decode(a)),"string"===typeof t&&(t=Z.base64.decode(t)),n=Uint8Array.from(n),t=Uint8Array.from(t),a=Uint8Array.from(a),r=Uint8Array.from(r),e.next=9,_().ready;case 9:return c=_(),e.prev=10,e.abrupt("return",c.crypto_aead_chacha20poly1305_ietf_decrypt_detached(null,r,a,null,t,n));case 14:throw e.prev=14,e.t0=e.catch(10),new T(""+e.t0);case 17:case"end":return e.stop()}}),e,null,[[10,14]])})))).apply(this,arguments)}function U(e){return N.apply(this,arguments)}function N(){return N=(0,c.Z)((0,i.Z)().mark((function e(n){var t,r,o,u,s,f,l,p,g,d,m,y;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=(n=n||{}).digestAlgo||"blake2b-512",r=new Uint8Array(D),o=0,u=0,(s=n.key)?"string"===typeof s&&(s=Z.base64.decode(s)):s=(0,M.getRandom)(32),f=new h.Hacheur({hashingCode:t}),e.next=9,f.ready;case 9:return e.next=11,_().ready;case 11:return l=_(),p=l.crypto_secretstream_xchacha20poly1305_init_push(s),g=p.state,d=Z.base64.encode(new Uint8Array(p.header)),m=null,y=null,e.abrupt("return",{update:function(){var e=(0,c.Z)((0,i.Z)().mark((function e(n){var t,a,c;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Uint8Array.from(n),t=null;case 2:if(!(o+n.length>=D)){e.next=13;break}if(a=D-o,r.set(n.slice(0,a),o),n=n.slice(a),!1!==(c=l.crypto_secretstream_xchacha20poly1305_push(g,r,null,l.crypto_secretstream_xchacha20poly1305_TAG_MESSAGE))){e.next=9;break}throw new F("Erreur encodage");case 9:t=t?new Uint8Array([].concat((0,v.Z)(t),(0,v.Z)(c))):c,o=0,e.next=2;break;case 13:if(o+n.length<=D&&(r.set(n,o),o+=n.length),!t){e.next=18;break}return e.next=17,f.update(t);case 17:u+=t.length;case 18:return e.abrupt("return",t);case 19:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),finalize:function(){var e=(0,c.Z)((0,i.Z)().mark((function e(){var n;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!1!==(n=l.crypto_secretstream_xchacha20poly1305_push(g,r.slice(0,o),null,l.crypto_secretstream_xchacha20poly1305_TAG_FINAL))){e.next=3;break}throw new F("Erreur encodage");case 3:return e.next=5,f.update(n);case 5:return u+=n.length,e.next=8,f.finalize();case 8:return m=e.sent,y={key:s,header:d,hachage:m,taille:u,format:"mgs4"},e.abrupt("return",(0,a.Z)((0,a.Z)({},y),{},{ciphertext:n}));case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),header:function(e){function n(){return e.apply(this,arguments)}return n.toString=function(){return e.toString()},n}((function(){return d})),hachage:function(e){function n(){return e.apply(this,arguments)}return n.toString=function(){return e.toString()},n}((function(){return m})),key:function(e){function n(){return e.apply(this,arguments)}return n.toString=function(){return e.toString()},n}((function(){return s})),format:function(){return"mgs4"},etatFinal:function(e){function n(){return e.apply(this,arguments)}return n.toString=function(){return e.toString()},n}((function(){return y}))});case 17:case"end":return e.stop()}}),e)}))),N.apply(this,arguments)}function I(e,n){return K.apply(this,arguments)}function K(){return K=(0,c.Z)((0,i.Z)().mark((function e(n,t){var r,a,o,u,s;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new Uint8Array(S),a=0,o=0,"string"===typeof n&&(n=Z.base64.decode(n)),"string"===typeof t&&(t=Z.base64.decode(t)),e.next=6,_().ready;case 6:return u=_(),s=u.crypto_secretstream_xchacha20poly1305_init_pull(t,n),e.abrupt("return",{update:function(){var e=(0,c.Z)((0,i.Z)().mark((function e(n){var t,c,f,l;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Uint8Array.from(n),null,t=new Uint8Array(n.length+S),c=0;case 4:if(!(a+n.length>=S)){e.next=16;break}if(f=S-a,r.set(n.slice(0,f),a),n=n.slice(f),!1!==(l=u.crypto_secretstream_xchacha20poly1305_pull(s,r))){e.next=11;break}throw new T("Erreur dechiffrage");case 11:t.set(l.message,c),c+=l.message.length,a=0,e.next=4;break;case 16:return a+n.length<=S&&(r.set(n,a),a+=n.length),o+=c,e.abrupt("return",t.slice(0,c));case 19:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),finalize:function(){var e=(0,c.Z)((0,i.Z)().mark((function e(){var n,t,c;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!a){e.next=7;break}if(!1!==(t=u.crypto_secretstream_xchacha20poly1305_pull(s,r.slice(0,a)))){e.next=4;break}throw new T("crypto_secretstream_xchacha20poly1305_pull Erreur dechiffrage");case 4:c=t.message,o+=(n=c).length;case 7:return e.abrupt("return",{taille:o,message:n});case 8:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()});case 9:case"end":return e.stop()}}),e)}))),K.apply(this,arguments)}function R(){return(R=(0,c.Z)((0,i.Z)().mark((function e(n,t){var r,a,c,o,u,s,f,l,p,h,g,d,m,v;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,U(t);case 2:r=e.sent,a=(Math.ceil(n.length/D)+1)*S,c=new Uint8Array(a),o=0,u=0;case 6:if(!(o<n.length)){e.next=16;break}return s=Math.min(n.length-o,D),f=n.slice(o,o+s),e.next=11,r.update(f);case 11:(l=e.sent)&&(c.set(l,u),u+=l.length),o+=s,e.next=6;break;case 16:return e.next=18,r.finalize();case 18:return p=e.sent,h=p.ciphertext,g=p.header,d=p.hachage,m=p.key,v=p.format,h&&(c.set(h,u),u+=h.length),e.abrupt("return",{key:m,ciphertext:c.slice(0,u),header:g,hachage:d,format:v});case 26:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function G(){return(G=(0,c.Z)((0,i.Z)().mark((function e(n,t,r){var a,c,o,u,s,f,l,p,h,g;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,I(n,t);case 2:a=e.sent,c=Math.ceil(r.length/S)*D,o=new Uint8Array(c),u=0,s=0;case 6:if(!(u<r.length)){e.next=16;break}return f=Math.min(r.length-u,S),l=r.slice(u,u+f),e.next=11,a.update(l);case 11:(p=e.sent)&&(o.set(p,s),s+=p.length),u+=f,e.next=6;break;case 16:return e.next=18,a.finalize();case 18:return h=e.sent,(g=h.message)&&(o.set(g,s),s+=g.length),e.abrupt("return",o.slice(0,s));case 22:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var F=function(e){(0,b.Z)(t,e);var n=(0,k.Z)(t);function t(){return(0,x.Z)(this,t),n.apply(this,arguments)}return(0,y.Z)(t)}((0,w.Z)(Error)),T=function(e){(0,b.Z)(t,e);var n=(0,k.Z)(t);function t(){return(0,x.Z)(this,t),n.apply(this,arguments)}return(0,y.Z)(t)}((0,w.Z)(Error)),j=function(e){(0,b.Z)(t,e);var n=(0,k.Z)(t);function t(){return(0,x.Z)(this,t),n.apply(this,arguments)}return(0,y.Z)(t)}((0,w.Z)(Error)),P={encrypt:function(e,n){return R.apply(this,arguments)},decrypt:function(e,n,t){return function(e,n,t){return G.apply(this,arguments)}(e,t.header,n)},getCipher:U,getDecipher:function(e,n){return I(e,n.header)},messageSize:D,stream:!0},B={encrypt:function(e,n){return A.apply(this,arguments)},decrypt:function(e,n,t){return function(e,n,t,r){return O.apply(this,arguments)}(e,t.nonce||t.iv,n,t.tag)},getCipher:W,getDecipher:W,stream:!1},z={encrypt:function(e,n){return e},decrypt:function(e,n,t){return n},getCipher:function(){return{update:function(e){return e},finalize:function(){return{}},header:function(e){function n(){return e.apply(this,arguments)}return n.toString=function(){return e.toString()},n}((function(){return header})),hachage:function(e){function n(){return e.apply(this,arguments)}return n.toString=function(){return e.toString()},n}((function(){return hachage})),key:function(e){function n(){return e.apply(this,arguments)}return n.toString=function(){return e.toString()},n}((function(){return key})),format:function(){return"dummy"},etatFinal:function(e){function n(){return e.apply(this,arguments)}return n.toString=function(){return e.toString()},n}((function(){return etatFinal}))}},getDecipher:function(){var e=new Uint8Array(S),n=0;return{update:function(t){t=Uint8Array.from(t);for(var r=new Uint8Array(t.length+S),i=0;n+t.length>=S;){var a=S-n;e.set(t.slice(0,a),n),t=t.slice(a),r.set(e,i),i+=e.length,n=0}return n+t.length<=S&&(e.set(t,n),n+=t.length),i&&i,r.slice(0,i)},finalize:function(){return{}}}},messageSize:D,stream:!0};function W(){throw new j("cipher/decipher non supporte")}var L={"chacha20-poly1305":B,"stream-xchacha20poly1305":P,mgs3:B,mgs4:P,dummy:z};(0,C.setCiphers)(L);t(65129);var H=t(76373),Q=(t(26298),t(55428)),J=(t(32763),h.hacherCertificat,null),X=null,q=null;function V(e,n,t){return Y.apply(this,arguments)}function Y(){return(Y=(0,c.Z)((0,i.Z)().mark((function e(n,t,r){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=r||{},H.ed25519.privateKeyFromPem(t),J=new l.FormatteurMessageEd25519(n,t),e.next=5,J.ready;case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function $(e,n,t){(t=t||{}).attacherCertificat=!0;var r=t.kind;return t.DEBUG&&console.debug("Formatter domaine=%s, message : %O (opts: %O)",n,e,t),J.formatterMessage(r,e,(0,a.Z)((0,a.Z)({},t),{},{domaine:n}))}function ee(e,n){return n=n||{},console.debug("Signer message avec cle de MilleGrille: %O (cle: %O)",e,X),new l.SignateurMessageEd25519(X).signer(e)}function ne(e){return te.apply(this,arguments)}function te(){return(te=(0,c.Z)((0,i.Z)().mark((function e(n){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(X){e.next=7;break}if("string"!==typeof n){e.next=6;break}(X=H.ed25519.privateKeyFromPem(n)).pem=n,e.next=7;break;case 6:throw new Error("Format de cle privee inconnu");case 7:q&&q(!0);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function re(){return ie.apply(this,arguments)}function ie(){return(ie=(0,c.Z)((0,i.Z)().mark((function e(){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:X=null;try{q(!1)}catch(n){}case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var ae=t(90676),ce=t(25423),oe=null,ue=null;function se(e){return fe.apply(this,arguments)}function fe(){return(fe=(0,c.Z)((0,i.Z)().mark((function e(n){var t;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.info("Init x509Client"),oe=H.pki.certificateFromPem(n),ue=new p.CertificateStore(oe),e.next=5,(0,ae.getIdmg)(n);case 5:t=e.sent,t;case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function le(e,n){return ue.verifierChaine(e,{validityCheckDate:n})}function pe(e,n){return he.apply(this,arguments)}function he(){return(he=(0,c.Z)((0,i.Z)().mark((function e(n,t){var r,a,c,o,u,s,f,l,h,g,d;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=!!(t=t||{}).support_idmg_tiers,a=n.certificat,c=n.millegrille,o=n.estampille,u=new Date(1e3*o),s=!1,r&&c?(f=H.pki.certificateFromPem(c),l=new p.CertificateStore(f),s=l.verifierChaine(a,{validityCheckDate:u})):s=le(a,u),s){e.next=12;break}throw(h=new Error("Certificat invalide")).code=1,h.fields=["certificat"],h;case 12:return e.prev=12,g=H.pki.certificateFromPem(a[0]),e.next=16,(0,ce.verifierMessage)(n,g);case 16:e.next=26;break;case 18:throw e.prev=18,e.t0=e.catch(12),console.error("Erreur validation message",e.t0),(d=new Error(""+e.t0)).cause=e.t0,d.code=2,d.fields=["hachage_contenu","_signature"],d;case 26:return e.abrupt("return",!0);case 27:case"end":return e.stop()}}),e,null,[[12,18]])})))).apply(this,arguments)}h.hacherCertificat;var ge,de,me,ve=null,ye=null,xe=null,be=null,ke="",we=!1,Ce="";function Ze(e,n,t){ge=e,de=n,me=t}function Ee(e,n){return _e.apply(this,arguments)}function _e(){return(_e=(0,c.Z)((0,i.Z)().mark((function e(n,t){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(t=t||{}).DEBUG&&console.debug("Initialisation du CertificateStore avec %O",n),e.abrupt("return",se(n));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Me(){return ke&&ve&&we}function Se(e,n){return De.apply(this,arguments)}function De(){return(De=(0,c.Z)((0,i.Z)().mark((function e(n,t){var r,a,c;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=t||{},n!==ke){e.next=3;break}return e.abrupt("return");case 3:if(!Me()){e.next=6;break}return console.info("connexionClient.connecter() Connexion deja active, rien a faire"),e.abrupt("return",ve);case 6:if(r=new URL(n),t.DEBUG&&console.debug("Socket.IO connecter avec url %s",r.href),a=Ne(r.href,t),xe){c=xe,xe=a;try{c.disconnect().catch((function(e){return console.warn("Erreur deconnexion connexion remplacee (1) : %O",e)}))}catch(i){console.warn("Erreur deconnexion connexion remplacee (2) : %O",i)}}return Ge("connect",(function(){t.DEBUG&&console.debug("socket.io connecte a %O",r),ke=n,ge(we=!0),Oe(a).catch((function(e){return console.error("connexionClient.onConnect ERROR %O",e)}))})),Ge("reconnect",(function(){t.DEBUG&&console.debug("Reconnecte"),we=!0,Oe().catch((function(e){return console.error("connexionClient.onConnect ERROR %O",e)}))})),Ge("disconnect",(function(e){t.DEBUG&&console.debug("Disconnect socket.io (reason: %O)",e),we=!1,ge&&ge(!1),de&&de("")})),Ge("connect_error",(function(e){console.error("connexionClient Erreur socket.io : %O",e),we=!1,ge&&ge(!1),de&&de("")})),e.abrupt("return",a);case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ae(){return{fingerprint:ye.fingerprint,extensions:(0,p.extraireExtensionsMillegrille)(ye.cert)}}function Oe(e){return Ue.apply(this,arguments)}function Ue(){return(Ue=(0,c.Z)((0,i.Z)().mark((function e(n){var t;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=null,be&&be.resolve(),!n){e.next=10;break}return console.debug("connexionClient.onConnect Connexion initiale, getEtatAuth"),!0,e.next=7,n;case 7:t=e.sent,e.next=14;break;case 10:return e.next=12,ze("getEtatAuth",{},{noformat:!0});case 12:t=e.sent,ge&&ge(we,{reconnecte:!0});case 14:console.debug("connexionClient.onConnect %O",t),de&&t.nomUsager&&de(t.nomUsager).catch((function(e){console.error("connexionClient.onConnect Erreur _callbackSetUsager : %O",e)}));case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ne(e,n){return Ie.apply(this,arguments)}function Ie(){return(Ie=(0,c.Z)((0,i.Z)().mark((function e(n,t){var r,a,c,o,u,s;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(t=t||{}).DEBUG,a=t.transports||["websocket","polling"],ve&&console.debug("SOCKET EXISTANT : %O",ve),c=new URL(n),o="https://"+c.host,u=c.pathname,r&&console.debug("Connecter socket.io sur %s (opts: %O)",n,t),ve=(0,f.io)(o,{path:u,reconnection:!1,transports:a}),console.info("connexionClient _socket ouvert : ",ve),s=null,e.prev=11,e.next=14,new Promise((function(e,n){be&&be.reject("reconnecting");var t=setTimeout((function(){return n("timeout")}),15e3);be=s={resolve:e,reject:n,timeout:t}}));case 14:return e.prev=14,e.next=17,ze("getEtatAuth",{},{timeout:2500,noformat:!0});case 17:return e.abrupt("return",e.sent);case 20:return e.prev=20,e.t0=e.catch(14),e.abrupt("return",{ok:!1,err:"getEtatAuth: "+e.t0});case 23:e.next=28;break;case 25:e.prev=25,e.t1=e.catch(11),console.error("Erreur de connexion : %O",e.t1);case 28:return e.prev=28,s&&s.timeout&&clearTimeout(s.timeout),be=null,e.finish(28);case 32:case"end":return e.stop()}}),e,null,[[11,25,28,32],[14,20]])})))).apply(this,arguments)}function Ke(e,n,t){return Re.apply(this,arguments)}function Re(){return(Re=(0,c.Z)((0,i.Z)().mark((function e(n,t,r){var c;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(c=(r=r||{}).DEBUG)&&console.debug("initialiserFormatteurMessage PEM:\n%O\n",n),ye=new l.FormatteurMessageEd25519(n,t,(0,a.Z)((0,a.Z)({},r),{},{hacheurs:m})),e.next=6,V(n,t,r);case 6:return e.next=8,ye.ready;case 8:c&&console.debug("connexionClient.initialiserFormatteurMessage ready"),me&&me(!0);case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ge(e,n){if(!ve)return console.error("socketOn %s, _socket === null",e),void(n&&n(!1));ve.on(e,n)}function Fe(e,n){if(!ve)return!1;n?ve.off(e,n):ve.removeAllListeners(e)}function Te(){null!==ve?(ve.disconnect(),ve=null):console.warn("_socket n'est pas initialise, on ne peut pas deconnecter"),ye=null,me&&me(!1)}function je(){null!==ve&&(ve&&ve.connected&&ve.disconnect(),ve.connect())}function Pe(e){return Be.apply(this,arguments)}function Be(){return(Be=(0,c.Z)((0,i.Z)().mark((function e(n){return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",pe(n));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ze(e,n,t){return We.apply(this,arguments)}function We(){return(We=(0,c.Z)((0,i.Z)().mark((function e(n,t,r){var c,o,u;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(c=(r=r||{}).timeout||9e3,o=r.attachements,n){e.next=4;break}throw new TypeError("connexionClient.emitBlocking event null");case 4:if(!t||t.sig||!0===r.noformat){e.next=15;break}if(!(u=t.kind||r.kind)){e.next=14;break}if(ye){e.next=9;break}throw new Error("connexionClient.emitBlocking Formatteur de message non initialise");case 9:return e.next=11,ye.formatterMessage(u,t,r);case 11:t=e.sent,e.next=15;break;case 14:throw new Error("Il faut fournir opts.kind");case 15:return e.abrupt("return",new Promise((function(e,r){var i=setTimeout((function(e){r(new Error("emitBlocking "+n+": Timeout socket.io"))}),c),u=function(n){if(clearTimeout(i),n&&n.err)return r(n.err);n.sig&&n.certificat?pe(n).then((function(t){if(!0===t){var i=n;n.contenu&&((i=JSON.parse(n.contenu)).__original=n),e(i)}r("Reponse invalide (hachage/signature incorrect)")})).catch((function(e){console.error("Erreur validation reponse  %O : %O",n,e),r(e)})):e(n)};t?(o&&(t=(0,a.Z)((0,a.Z)({},t),{},{attachements:o})),ve.emit(n,t,u)):ve.emit(n,u)})));case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Le(e,n,t){return He.apply(this,arguments)}function He(){return(He=(0,c.Z)((0,i.Z)().mark((function e(n,t,r){var a;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=r||{},!t||t.sig||!0===r.noformat){e.next=8;break}if(a=t.kind||r.kind){e.next=5;break}throw new Error("Il faut fournir opts.kind");case 5:return e.next=7,ye.formatterMessage(a,t,r);case 7:t=e.sent;case 8:t?ve.emit(n,t):ve.emit(n);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Qe(e,n,t,r){return Je.apply(this,arguments)}function Je(){return Je=(0,c.Z)((0,i.Z)().mark((function e(n,t,r,o){var u,s;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=r||{},o=o||{},e.prev=2,e.next=5,ze(n,r,(0,a.Z)({kind:Q.KIND_COMMANDE},o));case 5:u=e.sent,e.next=14;break;case 8:return e.prev=8,e.t0=e.catch(2),console.warn("Erreur subscribe %s, attendre 5 secondes et ressayer",n),e.next=13,ze(n,r,(0,a.Z)({kind:Q.KIND_COMMANDE},o));case 13:u=e.sent;case 14:if(!u||!0!==u.ok){e.next=18;break}u.routingKeys.forEach((function(e){Ge(e,function(){var e=(0,c.Z)((0,i.Z)().mark((function e(n){var r,a;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=n.message).sig||!r.certificat){e.next=20;break}return e.next=4,pe(r);case 4:if(!0!==e.sent){e.next=17;break}return a=r,r.contenu&&((a=JSON.parse(r.contenu)).__original=r,n.message=a),e.prev=8,e.abrupt("return",t(n));case 12:e.prev=12,e.t0=e.catch(8),console.error("subscribe Erreur callback (1) : ",e.t0);case 15:e.next=18;break;case 17:console.error("subscribe callback Reponse invalide (hachage/signature incorrect) ",r);case 18:e.next=30;break;case 20:return console.warn("Reponse recue sans signature/cert : ",n),e.prev=21,e.next=24,t(n);case 24:return e.abrupt("return",e.sent);case 27:e.prev=27,e.t1=e.catch(21),console.error("subscribe Erreur callback (2) : ",e.t1);case 30:case"end":return e.stop()}}),e,null,[[8,12],[21,27]])})));return function(n){return e.apply(this,arguments)}}())})),e.next=21;break;case 18:throw(s=new Error("Erreur subscribe %s",n)).reponse=u,s;case 21:case"end":return e.stop()}}),e,null,[[2,8]])}))),Je.apply(this,arguments)}function Xe(e,n,t,r){return qe.apply(this,arguments)}function qe(){return(qe=(0,c.Z)((0,i.Z)().mark((function e(n,t,r,c){var o;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=r||{},c=c||{},Fe(n),e.next=6,ze(n,r,(0,a.Z)((0,a.Z)({},c),{},{noformat:!0}));case 6:(o=e.sent)&&!0===o.ok&&o.routingKeys.forEach((function(e){ve&&ve.removeAllListeners(e)})),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),console.error("Erreur unsubscribe : %O",e.t0);case 13:case"end":return e.stop()}}),e,null,[[0,10]])})))).apply(this,arguments)}function Ve(){return!!ye&&ye.ready()}function Ye(){ye=null,me&&me(!1)}function $e(){return en.apply(this,arguments)}function en(){return(en=(0,c.Z)((0,i.Z)().mark((function e(){var n,t,r,a,c,o,u,f,l,h;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Ce){e.next=2;break}return e.abrupt("return",Ce);case 2:return e.next=4,ze("getCertificatsMaitredescles",null,{kind:Q.MESSAGE_KINDS.KIND_REQUETE,noformat:!0,ajouterCertificat:!0});case 4:if(n=e.sent,t=[],n.err){e.next=49;break}r=!1,a=!1,e.prev=9,o=(0,s.Z)(n);case 11:return e.next=13,o.next();case 13:if(!(r=!(u=e.sent).done)){e.next=28;break}return f=u.value,e.prev=15,e.next=18,le(f);case 18:(l=e.sent)?(h=(0,p.extraireExtensionsMillegrille)(l),(h.roles||[]).includes("maitredescles")?t.push(f):console.warn("Certificat sans role maitredescles, rejete")):console.warn("Certificat maitre des cles invalide ",f),e.next=25;break;case 22:e.prev=22,e.t0=e.catch(15),console.error("getCertificatsMaitredescles Erreur validation ",e.t0);case 25:r=!1,e.next=11;break;case 28:e.next=34;break;case 30:e.prev=30,e.t1=e.catch(9),a=!0,c=e.t1;case 34:if(e.prev=34,e.prev=35,!r||null==o.return){e.next=39;break}return e.next=39,o.return();case 39:if(e.prev=39,!a){e.next=42;break}throw c;case 42:return e.finish(39);case 43:return e.finish(34);case 44:if(0!==t.length){e.next=47;break}return console.warn("Aucun certificat de maitre des cles valide n'a ete recu"),e.abrupt("return",null);case 47:Ce=t,setTimeout((function(){Ce=null}),3e5);case 49:return e.abrupt("return",t.length>0?t:null);case 50:case"end":return e.stop()}}),e,null,[[9,30,34,44],[15,22],[35,,39,43]])})))).apply(this,arguments)}function nn(e){return ze("genererChallengeWebAuthn",e,{noformat:!0})}function tn(e){return console.warn("Deprecated : connexionClient.upgradeProteger(), utiliser connexionClient.authentifier()"),rn(e)}function rn(e,n){return an.apply(this,arguments)}function an(){return(an=(0,c.Z)((0,i.Z)().mark((function e(n,t){var r,c,o,u,s;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=!0===(t=t||{}).noCallback,!n){e.next=10;break}return e.next=5,ze("upgrade",n,{noformat:!0});case 5:return(c=e.sent).nomUsager&&de&&de(c.nomUsager),e.abrupt("return",c);case 10:return e.next=12,ze("genererChallengeCertificat",null,{kind:Q.MESSAGE_KINDS.KIND_REQUETE});case 12:return o=e.sent,u=(0,a.Z)({},o.challengeCertificat),e.next=16,ze("upgrade",u,{kind:Q.MESSAGE_KINDS.KIND_COMMANDE,domaine:"login",action:"login",attacherCertificat:!0});case 16:return s=e.sent,!r&&s.nomUsager&&de&&de(s.nomUsager),e.abrupt("return",s);case 19:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function cn(){return(cn=(0,c.Z)((0,i.Z)().mark((function e(n,t){var r;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},e.prev=1,e.next=4,ze("getInfoUsager",(0,a.Z)((0,a.Z)({},t),{},{nomUsager:n}),{noformat:!0});case 4:return r=e.sent,e.abrupt("return",r);case 8:throw e.prev=8,e.t0=e.catch(1),console.error("Erreur getInfoUsager ",e.t0),e.t0;case 12:case"end":return e.stop()}}),e,null,[[1,8]])})))).apply(this,arguments)}function on(){return(on=(0,c.Z)((0,i.Z)().mark((function e(n,t){var r,a;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=!1!==(t=t||{}).noformat,!r,e.prev=3,console.debug("authentifierWebauthn Emettre : %O",n),e.next=7,ze("authentifierWebauthn",n,{kind:u.MESSAGE_KINDS.KIND_COMMANDE,domaine:"MaitreDesComptes",noformat:!0});case 7:return a=e.sent,console.debug("Reponse ",a),e.abrupt("return",a);case 12:throw e.prev=12,e.t0=e.catch(3),console.error("Erreur emitBlocking authentifierWebauthn",e.t0),e.t0;case 16:case"end":return e.stop()}}),e,null,[[3,12]])})))).apply(this,arguments)}(0,o.Jj)((0,a.Z)((0,a.Z)({},r),{},{ping:function(){return!0},chargerCompteUsager:function(){return ze("chargerCompteUsager",{},{kind:u.MESSAGE_KINDS.KIND_REQUETE,domaine:"CoreMaitreDesComptes",action:"chargerUsager",attacherCertificat:!0})},inscrireUsager:function(e,n){return ze("inscrireUsager",{nomUsager:e,csr:n},{noformat:!0})},declencherAjoutWebauthn:function(){return ze("challengeAjoutWebauthn",null,{noformat:!0})},genererCertificatNavigateur:function(e){return ze("genererCertificatNavigateur",e,{noformat:!0})},repondreChallengeRegistrationWebauthn:function(e){return ze("ajouterCleWebauthn",e,{kind:u.MESSAGE_KINDS.KIND_COMMANDE,domaine:"CoreMaitreDesComptes",action:"ajouterCle",attacherCertificat:!0})},getInfoUsager:function(e,n){return cn.apply(this,arguments)},authentifierCertificat:function(e){return ze("authentifierCertificat",(0,a.Z)({},e),{kind:u.MESSAGE_KINDS.KIND_COMMANDE,domaine:"login",attacherCertificat:!0})},authentifierWebauthn:function(e,n){return on.apply(this,arguments)},authentifierCleMillegrille:function(e){return console.debug("authentifierCleMillegrille %O",e),ze("authentifierCleMillegrille",e,{noformat:!0})},requeteListeApplications:function(e){return ze("topologie/listeApplicationsDeployees",{},{kind:u.MESSAGE_KINDS.KIND_REQUETE,domaine:"CoreTopologie",action:"listeApplicationsDeployees",attacherCertificat:!0})},activerDelegationParCleMillegrille:function(e){return ze("activerDelegationParCleMillegrille",e,{kind:u.MESSAGE_KINDS.KIND_COMMANDE,domaine:"CoreMaitreDesComptes",action:"ajouterDelegationSignee",attacherCertificat:!0})},ajouterCsrRecovery:function(e,n){return ze("ajouterCsrRecovery",{nomUsager:e,csr:n},{kind:u.MESSAGE_KINDS.KIND_COMMANDE,noformat:!0})},getRecoveryCsr:function(e){return ze("getRecoveryCsr",{code:e},{kind:u.MESSAGE_KINDS.KIND_COMMANDE,domaine:"CoreMaitreDesComptes",action:"getCsrRecoveryParcode",attacherCertificat:!0})},signerRecoveryCsr:function(e){return ze("signerRecoveryCsr",e,{kind:u.MESSAGE_KINDS.KIND_COMMANDE,domaine:"CoreMaitreDesComptes",action:"signerCompteUsager",attacherCertificat:!0})},getChallengeDelegation:function(){return ze("getChallengeDelegation",{},{kind:u.MESSAGE_KINDS.KIND_COMMANDE})},genererChallenge:function(e){return ze("genererChallenge",e,{kind:u.MESSAGE_KINDS.KIND_COMMANDE,domaine:"CoreMaitreDesComptes",action:"genererChallenge",attacherCertificat:!0})},signerCompteUsager:function(e){return ze("signerCompteUsager",e,{kind:u.MESSAGE_KINDS.KIND_COMMANDE,domaine:"CoreMaitreDesComptes",action:"signerCompteUsager",attacherCertificat:!0})},enregistrerCallbackEvenementsActivationFingerprint:function(e,n){return Qe("ecouterEvenementsActivationFingerprint",n,{fingerprintPk:e},{noformat:!0})},retirerCallbackEvenementsActivationFingerprint:function(e,n){return Xe("retirerEvenementsActivationFingerprint",n,{fingerprintPk:e},{noformat:!0})}}))},80950:function(){},46601:function(){},89214:function(){},8623:function(){},7748:function(){},85568:function(){},56619:function(){},77108:function(){},52361:function(){},94616:function(){},69862:function(){},40964:function(){},25172:function(){},15979:function(){},50390:function(){},3941:function(){},67234:function(){},40349:function(){},48107:function(){}},n={};function t(r){var i=n[r];if(void 0!==i)return i.exports;var a=n[r]={id:r,loaded:!1,exports:{}};return e[r].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}t.m=e,t.x=function(){var e=t.O(void 0,[414,802,888],(function(){return t(65569)}));return e=t.O(e)},function(){var e=[];t.O=function(n,r,i,a){if(!r){var c=1/0;for(f=0;f<e.length;f++){r=e[f][0],i=e[f][1],a=e[f][2];for(var o=!0,u=0;u<r.length;u++)(!1&a||c>=a)&&Object.keys(t.O).every((function(e){return t.O[e](r[u])}))?r.splice(u--,1):(o=!1,a<c&&(c=a));if(o){e.splice(f--,1);var s=i();void 0!==s&&(n=s)}}return n}a=a||0;for(var f=e.length;f>0&&e[f-1][2]>a;f--)e[f]=e[f-1];e[f]=[r,i,a]}}(),t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,{a:n}),n},t.d=function(e,n){for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},t.f={},t.e=function(e){return Promise.all(Object.keys(t.f).reduce((function(n,r){return t.f[r](e,n),n}),[]))},t.u=function(e){return"static/js/"+e+"."+{414:"63a06a7d",802:"ad904b7e",888:"42dc0549"}[e]+".chunk.js"},t.miniCssF=function(e){},t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e},t.p="/millegrilles/",function(){var e={297:1};t.f.i=function(n,r){e[n]||importScripts(t.p+t.u(n))};var n=self.webpackChunkmillegrilles_maitredescomptes_client=self.webpackChunkmillegrilles_maitredescomptes_client||[],r=n.push.bind(n);n.push=function(n){var i=n[0],a=n[1],c=n[2];for(var o in a)t.o(a,o)&&(t.m[o]=a[o]);for(c&&c(t);i.length;)e[i.pop()]=1;r(n)}}(),function(){var e=t.x;t.x=function(){return Promise.all([414,802,888].map(t.e,t)).then(e)}}();t.x()}();
//# sourceMappingURL=297.e4cbbc73.chunk.js.map