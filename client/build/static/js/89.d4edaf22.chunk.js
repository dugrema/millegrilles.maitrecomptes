(self.webpackChunkmillegrilles_maitredescomptes_client=self.webpackChunkmillegrilles_maitredescomptes_client||[]).push([[89],{58516:function(e,n,t){"use strict";t.d(n,{XH:function(){return k},t4:function(){return y},tK:function(){return C},se:function(){return A},xt:function(){return O},Cc:function(){return j}});var r=t(1413),a=t(74165),u=t(15861),i=t(29439),c=t(72791),s=t(43360),o=t(1827),l=t.n(o),f=t(31243),p=t(20829),h=(t(24214),t(86948)),d=t.n(h),g=t(19778).Buffer;function b(e,n,t){return m.apply(this,arguments)}function m(){return(m=(0,u.Z)((0,a.Z)().mark((function e(n,t,u){var i,c,s,o,l,f,p,h,b;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(i=(u=u||{}).DEBUG)&&console.debug("repondreRegistrationChallenge nomUsager: %s, attestation: %O",n,t),c=g.from(t.challenge,"base64"),t.attestation,s=g.from(t.user.id,"base64"),o=(0,r.Z)((0,r.Z)({},t),{},{challenge:c,user:(0,r.Z)((0,r.Z)({},t.user),{},{id:s,name:n,displayName:n})}),i&&console.debug("Registration options avec buffers : %O",o),e.next=10,navigator.credentials.create({publicKey:o});case 10:return l=e.sent,i&&console.debug("New credential : %O",l),f=l.response,p=d().encode(f.clientDataJSON),h=d().encode(new Uint8Array(f.attestationObject)),b={id:l.id,response:{attestationObject:h,clientDataJSON:p},type:l.type},e.abrupt("return",b);case 17:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var w=t(30616),x=t(7087),v=t(74405),Z=t(80184);function k(e){var n=e.variant,t=e.className,r=e.resetMethodes,a=e.confirmationCb,u=e.erreurCb,s=(0,x.ZP)().connexion,o=(0,x.ZY)()[0],l=o.nomUsager,f=o.fingerprintPk,h=(0,c.useState)(""),d=(0,i.Z)(h,2),g=d[0],b=d[1],m=(0,c.useState)(""),w=(0,i.Z)(m,2),v=w[0],k=w[1],y=(0,c.useCallback)((function(e){k("attente"),e.preventDefault(),e.stopPropagation(),console.debug("Ajout methode pour nomUsager %s, fingerprintPkCourant %O, challenge %O",l,f,g),function(e,n,t,r,a,u){return S.apply(this,arguments)}(s,l,f,g,r,{DEBUG:!0}).then((function(e){console.debug("Resultat ajouter methode : ",e),k("succes"),a&&a()})).catch((function(e){k("echec"),u(e,"Erreur ajouter methode")}))}),[s,l,f,g,r,a,u,k]);return(0,c.useEffect)((function(){(function(e){return P.apply(this,arguments)})(s).then((function(e){console.debug("BoutonAjouterWebauthn Challenge registration : ",e),b(e)})).catch((function(e){return u(e,"Erreur preparation challenge pour ajouter methode")}))}),[s,b,a,u]),(0,Z.jsx)(p.BoutonActif,{variant:n,className:t,etat:v,onClick:y,disabled:!g,children:e.children})}function y(e){var n=e.variant,t=e.className,r=e.usagerDb,a=e.challenge,u=e.dureeSession,s=e.onError,o=e.onSuccess,l=(0,x.ZP)();console.debug("BoutonAuthentifierWebauthn usagerDb %O",r);var f=l.connexion,h=r.nomUsager,d=r.requete,g=(0,c.useState)(""),b=(0,i.Z)(g,2),m=b[0],w=b[1],v=(0,c.useState)(!1),k=(0,i.Z)(v,2),y=k[0],C=k[1],O=(0,c.useState)(!1),D=(0,i.Z)(O,2),U=D[0],P=D[1],S=(0,c.useCallback)((function(e,n){P(!0),s(e,n)}),[P,s]),E=(0,c.useCallback)((function(e){console.debug("BoutonAuthentifierWebauthn.authentifierCb Authentifier reponseChallengeAuthentifier: %O",m),P(!1),C(!0);var n=m.demandeCertificat,t=m.publicKey;(function(e,n,t,r,a){return B.apply(this,arguments)})(f,h,n,t,{dureeSession:u}).then((function(e){console.debug("BoutonAuthentifierWebauthn Reponse authentifier ",e),o(e)})).catch((function(e){return S(e,"BoutonAuthentifierWebauthn.authentifierCb Erreur authentification")})).finally((function(){C(!1)}))}),[f,h,u,m,o,C,P,S]);(0,c.useEffect)((function(){a&&A(h,a,d).then((function(e){console.debug("Reponse preparerAuthentification nomUsager %s, challenge %O, requeteCsr %s : %O",h,a,d,e),w(e)})).catch((function(e){return s(e,"BoutonAuthentifierWebauthn.authentifierCb Erreur preparation authentification")}))}),[h,a,d,w,s]);var j="";return U?j="echec":y&&(j="attente"),(0,Z.jsx)(p.BoutonActif,{variant:n,className:t,challenge:a,etat:j,onClick:E,disabled:!m,children:e.children})}function C(e){var n=e.variant,t=e.className,r=e.usager,o=e.setAttente,l=e.onSuccess,f=e.onError,p=(0,x.ZP)(),h=r||{},d=h.nomUsager,g=h.requete,b=(0,c.useState)(""),m=(0,i.Z)(b,2),w=m[0],v=m[1],k=(0,c.useCallback)((function(){o&&o(!0),console.debug("majCertificatCb requete : %O, csrChallenge: %O",g,w);var e=w.demandeCertificat,n=w.publicKey,t=w.challengeReference;(function(e,n,t,r,a){return U.apply(this,arguments)})(p,d,e,n,t).then((function(e){l&&l(e)})).catch((function(e){f?f(e):console.error("Erreur : %O",e)})).finally((function(){o&&o(!1)}))}),[p,d,g,w,o,l,f]);return(0,c.useEffect)((function(){if(d&&g){var e=window.location.hostname;p.connexion.genererChallenge({hostname:e,webauthnAuthentication:!0}).then(function(){var e=(0,u.Z)((0,a.Z)().mark((function e(n){var t;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.debug("BoutonMajCertificatWebauthn Reponse challenge ",n),e.next=3,A(d,n.authentication_challenge,g);case 3:t=e.sent,console.debug("BoutonMajCertificatWebauthn CSR Challenge ",t),v(t);case 6:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}()).catch(f)}}),[p,d,g,v,f]),(0,Z.jsx)(s.Z,{variant:n,className:t,onClick:k,disabled:!w,children:e.children})}function O(e,n){return D.apply(this,arguments)}function D(){return(D=(0,u.Z)((0,a.Z)().mark((function e(n,t){var r,u,i,c,s,o;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.connexion,e.next=3,(0,v.q3)(t);case 3:return u=e.sent,console.debug("Nouvelle cle generee : %O",u),i=window.location.hostname,e.next=8,r.getInfoUsager(t,{hostname:i,genererChallenge:!0});case 8:if(c=e.sent,console.debug("Etat usager backend : %O",c),s=c.authentication_challenge){e.next=13;break}return e.abrupt("return",null);case 13:return e.next=15,A(t,s,u);case 15:return o=e.sent,e.abrupt("return",{cleCsr:u,challengeWebAuthn:s,reponseChallengeAuthentifier:o});case 17:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function U(){return(U=(0,u.Z)((0,a.Z)().mark((function e(n,t,r,u,i){var c,s,o,l;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=n.connexion,console.debug("majCertificat signer %O / publicKey %O, challenge reference : %O",r,u,i),e.next=4,j(t,r,u);case 4:return s=e.sent,console.debug("majCertificat Demande certificat signee avec webauthn : %O",s),o={demandeCertificat:s.demandeCertificat,challenge:i,hostname:window.location.hostname,clientAssertionResponse:s.webauthn},e.next=9,c.signerCompteUsager(o);case 9:return l=e.sent,e.abrupt("return",l);case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function P(){return(P=(0,u.Z)((0,a.Z)().mark((function e(n){var t,r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.debug("Charger challenge ajouter webauthn"),t=window.location.hostname,e.next=4,n.genererChallenge({hostname:t,webauthnRegistration:!0});case 4:return r=e.sent,console.debug("Challenge : %O",r),e.abrupt("return",r.registration_challenge);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function S(){return(S=(0,u.Z)((0,a.Z)().mark((function e(n,t,r,u,i,c){var s,o,l,f,p;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=c||{},u.publicKey&&(u=u.publicKey),e.next=4,b(t,u,c);case 4:return s=e.sent,console.debug("Reponse ajout webauthn : %O",s),o=window.location.hostname,l={reponseChallenge:s,fingerprintPk:r,hostname:o},i&&(l.reset_cles=!0),console.debug("reponseChallenge : %O",l),e.next=12,n.repondreChallengeRegistrationWebauthn(l);case 12:if(f=e.sent,console.debug("Resultat ajout : %O",f),!0===f.ok){e.next=18;break}throw(p=new Error("Erreur, ajout methode refusee (back-end)")).reponse=f,p;case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function A(e,n,t,r){return E.apply(this,arguments)}function E(){return(E=(0,u.Z)((0,a.Z)().mark((function e(n,t,u,i){var c,s,o,f,p,h,d;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=i||{},t){e.next=3;break}throw new Error("preparerAuthentification challengeWebauthn absent");case 3:if(console.debug("Preparer authentification avec : ",t),c=t.publicKey.challenge,(s=(0,r.Z)({},t.publicKey)).challenge=l().toBuffer(s.challenge),s.allowCredentials=(s.allowCredentials||[]).map((function(e){var n=l().toBuffer(e.id);return(0,r.Z)((0,r.Z)({},e),{},{id:n})})),o=null,!u){e.next=22;break}return f=u.csr||u,o={nomUsager:n,csr:f,date:Math.floor((new Date).getTime()/1e3)},!0===i.activationTierce&&(o.activationTierce=!0),e.next=15,(0,w.hacherMessage)(o,{bytesOnly:!0,hashingCode:"blake2s-256"});case 15:p=e.sent,console.debug("Hachage demande cert %O = %O, ajouter au challenge existant de : %O",p,o,s.challenge),(h=new Uint8Array(64)).set(s.challenge,0),h.set(p,32),s.challenge=h,console.debug("Challenge override pour demander signature certificat : %O",s.challenge);case 22:return d={publicKey:s,demandeCertificat:o,challengeReference:c},console.debug("Prep publicKey/demandeCertificat : %O",d),e.abrupt("return",d);case 25:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function B(){return(B=(0,u.Z)((0,a.Z)().mark((function e(n,t,r,u,i){var c,s,o,l,p;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.debug("Signer challenge : %O (opts: %O)",u,i),c=(i=i||{}).dureeSession,t){e.next=5;break}throw new Error("authentifier Nom usager manquant");case 5:return e.next=7,j(t,r,u,{connexion:n,dureeSession:c});case 7:return s=e.sent,console.debug("Data a soumettre pour reponse webauthn : %O",s),e.next=11,f.Z.post("/auth/authentifier_usager",s);case 11:if(o=e.sent,console.debug("Resultat authentification : %O",o),l=o.data,!(p=JSON.parse(l.contenu)).userId){e.next=19;break}return e.abrupt("return",p);case 19:throw new Error("WebAuthn.authentifier Erreur authentification");case 20:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function j(e,n,t,r){return N.apply(this,arguments)}function N(){return(N=(0,u.Z)((0,a.Z)().mark((function e(n,t,r,u){var i,c,s,o,f;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u=u||{},n){e.next=3;break}throw new Error("signerDemandeAuthentification Nom usager manquant");case 3:return"string"===typeof(i=u.dureeSession)&&(i=Number.parseInt(i)),c={nomUsager:n,demandeCertificat:t},i&&(c.dureeSession=i),e.next=9,navigator.credentials.get({publicKey:r});case 9:return s=e.sent,o=s.response,f={id64:l().encode(new Uint8Array(s.rawId)),response:{authenticatorData:o.authenticatorData?l().encode(new Uint8Array(o.authenticatorData)):null,clientDataJSON:o.clientDataJSON?l().encode(new Uint8Array(o.clientDataJSON)):null,signature:o.signature?l().encode(new Uint8Array(o.signature)):null,userHandle:o.userHandle?l().encode(new Uint8Array(o.userHandle)):null},type:s.type},console.debug("Reponse serialisable : %O",f),c.webauthn=f,c.challenge=r.challenge,e.abrupt("return",c);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},74405:function(e,n,t){"use strict";t.d(n,{Gd:function(){return k},L5:function(){return D},Ry:function(){return x},ei:function(){return b},q3:function(){return m},rg:function(){return d}});var r=t(37762),a=t(74165),u=t(1413),i=t(93433),c=t(15861),s=t(31243),o=t(20829),l=t(5894),f=t(98052),p=t(83653),h=t(19778).Buffer;function d(e,n,t){return g.apply(this,arguments)}function g(){return(g=(0,c.Z)((0,a.Z)().mark((function e(n,t,r){var c,s,l,f;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=r||{},c=p.pki.certificateFromPem(t[0]),(s=c.subject.getField("CN").value)===n){e.next=5;break}throw new Error("Certificat pour le mauvais usager : ".concat(s," !== ").concat(n));case 5:if(!((l=(0,i.Z)(t)).length<2)){e.next=8;break}throw new Error("Certificat recu n'a pas intermediaire/CA (len=".concat(t.length,"): ").concat(t.join("")));case 8:return f=(0,u.Z)((0,u.Z)({},r),{},{requete:null}),3===l.length&&(f.ca=l.pop()),f.certificat=l,e.next=13,o.usagerDao.updateUsager(n,f);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function b(e){var n=e;return"string"===typeof e&&(n=p.pki.certificateFromPem(e)),(0,l.extraireExtensionsMillegrille)(n).userId}function m(e){return w.apply(this,arguments)}function w(){return(w=(0,c.Z)((0,a.Z)().mark((function e(n){var t,r,u;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,f.genererClePrivee)();case 2:return t=e.sent,r=h.from(t.publicKey.publicKeyBytes).toString("hex"),console.debug("Fingerprint publickey : %O \n(bytes : %O)",r,t.publicKey.publicKeyBytes),e.next=7,(0,f.genererCsrNavigateur)(n,t.pem);case 7:return u=e.sent,e.abrupt("return",{fingerprint_pk:r,csr:u,clePriveePem:t.pem});case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function x(e,n){return v.apply(this,arguments)}function v(){return(v=(0,c.Z)((0,a.Z)().mark((function e(n,t){var r,i,c,s,l,f,p,h,d,g,b;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t||(t={}),n){e.next=3;break}throw new Error("Usager null");case 3:return e.next=5,o.usagerDao.getUsager(n);case 5:if(r=e.sent,i=r?r.certificat:null,c=!1,r){e.next=12;break}c=!0,e.next=28;break;case 12:if(!0!==t.regenerer){e.next=16;break}c=!0,e.next=28;break;case 16:if(i||r.requete){e.next=20;break}c=!0,e.next=28;break;case 20:if(!i){e.next=28;break}if(s=Z(i),l=s.certificatValide,f=s.canRenew,l){e.next=27;break}return e.next=25,o.usagerDao.updateUsager(n,{nomUsager:n,certificat:null,clePriveePem:null,fingerprintPk:null});case 25:r.certificat=null,r.clePriveePem=null;case 27:!f&&l||(console.warn("Certificat invalide ou date de renouvellement atteinte"),c=!0);case 28:if(!c){e.next=37;break}return e.next=31,m(n);case 31:return p=e.sent,h=p.csr,d=p.clePriveePem,g=p.fingerprint_pk,b={csr:h,clePriveePem:d,fingerprintPk:g},e.next=36,o.usagerDao.updateUsager(n,{nomUsager:n,requete:b});case 36:r=(0,u.Z)((0,u.Z)({},r),{},{nomUsager:n,requete:b});case 37:return e.abrupt("return",r);case 38:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Z(e){var n=p.pki.certificateFromPem(e.join("")),t=n.validity.notAfter.getTime(),r=n.validity.notBefore.getTime(),a=(t-r)/3*2+r;return{certificatValide:(new Date).getTime()<t,canRenew:(new Date).getTime()>a}}function k(e,n,t,r){return y.apply(this,arguments)}function y(){return(y=(0,c.Z)((0,a.Z)().mark((function e(n,t,r,i){var c,o,l,f,p,h;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=i||{},c=window.location.hostname,o=(0,u.Z)((0,u.Z)({nomUsager:n,hostname:c},i),{},{fingerprintPkNouveau:t,fingerprintPkCourant:r}),e.next=5,(0,s.Z)({method:"POST",url:"/auth/get_usager",data:o,timeout:2e4});case 5:return l=e.sent,f=l.data,p=JSON.parse(f.contenu),console.debug("chargerUsager Reponse ",p),h=!!p&&p.auth,e.abrupt("return",{nomUsager:n,infoUsager:p,authentifie:h});case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var C=["collections","documents","messagerie"],O=["fichiersDechiffresTmp"];function D(){return U.apply(this,arguments)}function U(){return(U=(0,c.Z)((0,a.Z)().mark((function e(){var n,t,u,i,c,s,l,f,p;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("indexedDB"in window)){e.next=33;break}if(n=C,!("databases"in window.indexedDB)){e.next=8;break}return console.debug("Supporte indexedDB.databases()"),e.next=6,window.indexedDB.databases();case 6:n=e.sent,console.log(n);case 8:t=[],u=(0,r.Z)(n),e.prev=10,c=(0,a.Z)().mark((function e(){var n,r;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("millegrilles"!==(n=i.value)){e.next=3;break}return e.abrupt("return",1);case 3:console.debug("Supprimer database %s",n),r=new Promise((function(e,t){var r=window.indexedDB.deleteDatabase(n);r.onblocked=function(e){console.warn("delete blocked sur database %s : %O",n,e)},r.onerror=function(t){console.warn("Erreur suppression database %s : %O",n,t),e()},r.onsuccess=function(){console.debug("Database %s supprimee",n),e()}})),t.push(r);case 6:case"end":return e.stop()}}),e)})),u.s();case 13:if((i=u.n()).done){e.next=19;break}return e.delegateYield(c(),"t0",15);case 15:if(!e.t0){e.next=17;break}return e.abrupt("continue",17);case 17:e.next=13;break;case 19:e.next=24;break;case 21:e.prev=21,e.t1=e.catch(10),u.e(e.t1);case 24:return e.prev=24,u.f(),e.finish(24);case 27:if(t.push(o.usagerDao.clearClesDechiffrees()),caches){s=caches,l=(0,r.Z)(O);try{for(l.s();!(f=l.n()).done;)p=f.value,t.push(s.delete(p))}catch(h){l.e(h)}finally{l.f()}}return e.next=31,Promise.all(t);case 31:e.next=34;break;case 33:console.debug("IDB non supporte");case 34:case"end":return e.stop()}}),e,null,[[10,21,24,27]])})))).apply(this,arguments)}},30616:function(e,n,t){"use strict";t(36227);var r=t(9114);t.o(r,"SignateurMessageEd25519")&&t.d(n,{SignateurMessageEd25519:function(){return r.SignateurMessageEd25519}}),t.o(r,"hacherMessage")&&t.d(n,{hacherMessage:function(){return r.hacherMessage}})},36227:function(e,n,t){"use strict";var r=t(74165),a=t(15861),u=t(29781),i=t(81762),c=function(){var e=(0,a.Z)((0,r.Z)().mark((function e(n){var t;return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n();case 2:return t=e.sent,e.abrupt("return",{update:function(e){return t.update(e)},finalize:function(){return t.digest("binary")},digest:function(){var e=(0,a.Z)((0,r.Z)().mark((function e(n){return(0,r.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.update(n);case 2:return e.next=4,t.digest("binary");case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}()});case 4:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),s={sha256:function(){return c(i.TX)},"sha2-256":function(){return c(i.TX)},sha512:function(){return c(i.h0)},"sha2-512":function(){return c(i.h0)},blake2s256:function(){return c(i.zc)},"blake2s-256":function(){return c(i.zc)},blake2b512:function(){return c(i.Hp)},"blake2b-512":function(){return c(i.Hp)}};(0,u.setHacheurs)(s)},25172:function(){},15979:function(){}}]);
//# sourceMappingURL=89.d4edaf22.chunk.js.map