#!/usr/bin/env node
const debug = require('debug')('maitrecomptes:www')
const express = require('express')

const server6 = require('@dugrema/millegrilles.nodejs/src/server6')
const comptesUsagers = require('@dugrema/millegrilles.nodejs/src/comptesUsagersDao')

const socketApp = require('../models/appSocketIo')
const {initialiser: initialiserMillegrilles} = require('../routes/millegrilles')
const { TopologieDao } = require('../models/topologieDao')
const { MaitreClesDao }  = require('../models/maitreClesDao')
const { init: initCallbacks, enregistrerCallbacks } = require('../models/mqEventsHandler')

const _hostname = process.env.HOST,
      CONST_SESSION_TIMEOUT =  12 * (60 * 60 * 1000)  // session expire apres 12 heures (en millisecs)
var _idmg

if(!_hostname) {
  console.error("Il faut fournir la variable d'environnement HOST")
  process.exit(-1)
}

async function init() {

  // Initialiser server et routes
  const optsServer6 = {
    pathApp: '/millegrilles',
    cookiePath: '/',                // Permet au cookie d'etre transmis pour toutes les sous-apps
    noPreAuth: true,                // Aucune verification de session/autorisation automatique - va etre faite dans l'application
    maxAge: CONST_SESSION_TIMEOUT,
    verifierAutorisation, 
    exchange: '2.prive',
  }

  const app = express()
  const routeMillegrilles = express.Router()

  const {socketIo, amqpdao: amqpdaoInst} = await server6(app, socketApp.configurerEvenements, optsServer6)

  app.use('/millegrilles', routeMillegrilles)

  _idmg = amqpdaoInst.pki.idmg
  console.info("****************\nDemarrage serveur maitre des comptes (/millegrilles)")
  console.info("Hostname %s\nIDMG     %s", _hostname, _idmg)
  socketApp.init(_hostname, _idmg)
  console.info("****************")

  initCallbacks(amqpdaoInst, socketIo)
  enregistrerCallbacks()

  // Inserer les routes apres l'initialisation, permet d'avoir le middleware
  // attache avant (app.use comme le logging morgan, injection amqpdao, etc.)
  const {middlewareExpress, middlewareSocket, extraireUsager} = preparerDaos(amqpdaoInst)
  socketIo.use(middlewareSocket)

  routeMillegrilles.use(middlewareExpress)
  routeMillegrilles.use(initialiserMillegrilles(_hostname, amqpdaoInst, extraireUsager))

  routeMillegrilles.use(express.static('static/'))
}

function preparerDaos(amqpdaoInst) {

  const topologieDao = new TopologieDao(amqpdaoInst)
  const maitreClesDao = new MaitreClesDao(amqpdaoInst)
  const {extraireUsager} = comptesUsagers(amqpdaoInst)

  const middlewareExpress = (req, res, next) => {
    req.topologieDao = topologieDao
    req.maitreClesDao = maitreClesDao
    next()
  }

  const middlewareSocket = (socket, next) => {
    socket.topologieDao = topologieDao
    socket.maitreClesDao = maitreClesDao
    // socket.comptesUsagersDao = comptesUsagersDao  // Deja injecte par server4
    next()
  }

  return {middlewareExpress, middlewareSocket, extraireUsager}
}

function verifierAutorisation(_socket, securite, certificatForge) {

  let prive = false, protege = false

  const extensions = extraireExtensionsMillegrille(certificatForge)

  if(['proprietaire', 'delegue'].includes(extensions.delegationGlobale)) {
      // Deleguation globale donne tous les acces
      debug("Usager proprietaire, acces 3.protege OK")
      prive = true
      protege = true
  } else if(securite === '3.protege') {
      const roles = extensions.roles || []
      if(roles.includes('compte_prive')) {
          debug("Usager prive, acces 2.prive OK")
          prive = true
      }
  }
  
  return {prive, protege}
}

// Demarrer le serveur
init()
  .then(_=>{
    console.info("Serveur pret")
  })
  .catch(err=>{
    console.error("*** ERREUR Demarrage ***")
    console.error(err)

    // Arreter le serveur
    process.exit(2)
  })
